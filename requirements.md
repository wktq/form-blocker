# 要件定義書

## 1. **システム概要**

### 1.1 目的

このシステムは、企業の公式 Web フォームに対して、営業目的やスパム的な送信をブロックし、正当な問い合わせが確実に届くようにするためのツールです。システムは、簡単な**埋め込みスクリプト**と、**管理画面**を通じて、リアルタイムで送信を監視・管理します。

---

## 2. **システム構成**

### 2.1 構成要素

1. **管理画面**
   ユーザーがフォーム設定、通知設定、ブロックされた送信の確認などを行うためのインターフェース。

2. **埋め込みスクリプト**
   ユーザーの Web サイトに埋め込むためのスニペットコードで、リアルタイムで送信内容を監視します。

3. **バックエンド**
   リクエストを受けて、営業目的やスパムの判定を行うサーバー側のロジック。

---

## 3. **管理画面機能**

### 3.1 埋め込み URL のコピー画面

- **機能**：

  - ユーザーが自身の Web サイトに埋め込むための**スニペットコード**を生成。
  - 埋め込みコードの表示と**コピー機能**を提供。
  - 簡単な**埋め込み手順の説明**を表示。

- **UI 要素**：

  - 埋め込み用スニペットコードのテキストエリア。
  - コピー用ボタン。
  - 簡単な手順説明欄。

### 3.2 フォーム設定画面

- **機能**：

  - ユーザーがフォームの**問い合わせ内容**を設定。
  - **URL 検出機能**の有無を設定。
  - 営業目的やスパムを判定するための**閾値設定**（例えば、URL 比率、文字数に基づくスコア設定）を行う。
  - 設定内容をプレビューすることで、リアルタイムに反映を確認できる。

- **UI 要素**：

  - 問い合わせ内容セレクター（選択肢、テキストエリア）。
  - URL 検出オプション（チェックボックス）。
  - 検出閾値設定スライダー（営業目的判定、スパム判定）。
  - 設定のプレビューボタン。

### 3.3 通知設定画面

- **機能**：

  - **通知条件**を設定（例えば、営業判定が 80%を超えた場合に通知）。
  - 通知の**方法設定**（メール、ダッシュボード通知、Webhook など）。
  - 通知設定が正しく反映されているか確認する機能。

- **UI 要素**：

  - 通知条件の設定（営業判定、スパム判定など）。
  - 通知方法の選択（メール、ダッシュボード、Webhook）。
  - 設定確認ボタン。

### 3.4 ブロックされた送信の一覧画面

- **機能**：

  - **ブロックされた送信**の一覧表示（送信者、日時、スコア、判定理由）。
  - 各送信の詳細（本文、判定理由）を表示。
  - フィルタリング機能（日時、送信者、判定理由）による絞り込み。
  - **誤検知**や**異議申立て**の内容も確認可能。

- **UI 要素**：

  - ブロックされた送信のリストビュー。
  - フィルター機能（日時、判定理由など）。
  - 各送信の詳細情報を表示するボタン。
  - 誤検知のフィードバックボタン。

---

## 4. **埋め込みスクリプトの要件**

### 4.1 スクリプト機能

- **フォーム要素の自動検出**：

  - フォームの`<form>`タグや入力フィールド（`<input>`、`<textarea>`）を自動で検出し、送信をインターセプト。

- **リアルタイム判定**：

  - ユーザーがフォームに入力する際、**onChange イベント**で入力内容をリアルタイムに監視。
  - 怪しい入力（貼り付けや禁止語、URL 検出）を判定し、**即座にフラグを立てる**。

- **バックエンドとの連携**：

  - ユーザーが送信ボタンを押すと、フォーム内容をバックエンド API（判定 API）に送信し、営業目的やスパム判定を行う。
  - 結果に応じて、**許可/チャレンジ/保留/ブロック**を行い、ユーザーにフィードバックを表示。

- **誤検知防止機能**：

  - 不正判定された場合には、ユーザーに異議申立ての手続きを提供。

### 4.2 スクリプト設置方法

- ユーザーがサイトに埋め込むための**スニペットコード**を提供。
- `script`タグをページ内の`<head>`または`<body>`タグに埋め込むだけで機能する。

---

## 5. **バックエンド機能**

### 5.1 判定エンジン

- **ステップ 1**：

  - リアルタイムで送信内容を受け取り、**営業目的/スパム判定**のための**軽量ルールベース**での事前チェック（URL 比率、禁止語の検出など）。

- **ステップ 2**：

  - ステップ 1 で怪しいとマークされた送信内容を**LLM**で精度高く最終判定。
  - 判定結果を`allow/challenge/hold/block`に分類し、判定理由も付与。

- **ステップ 3**：

  - 判定結果に基づいて、リアルタイムに送信フォームの結果を返却。
  - 結果が`block`の場合は、送信者に異議申立てのオプションを提示。

### 5.2 API エンドポイント

- **/evaluate**：

  - 入力されたフォーム内容を受け取り、営業目的やスパム判定を行う。

- **/challenge/verify**：

  - チャレンジ判定時の自己申告内容を再評価し、最終結果を返す。

- **/appeal**：

  - ブロックされた送信について異議申立てを受け付け、最終判定を行う。

- **/feedback**：

  - ユーザーからのフィードバックを受け取り、学習データとして活用。

---

## 6. **セキュリティとプライバシー**

### 6.1 セキュリティ

- **API 認証**：supabase auth に認証を行い、ユーザー認証を強化。
- **データ暗号化**：送信データと保存データは**TLS で暗号化**し、保存時にも**AES 暗号化**。

## 7. **テクニカル要件**

- **プラットフォーム**：Web に埋め込み可能。
- **バックエンド**：Node.js で API 実装。
- **データベース**：supabase を使用
