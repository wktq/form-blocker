// Form Blocker Embedded Script (Mockup Version)
(function() {
  'use strict';

  var FormBlocker = {
    config: {},
    apiUrl: window.location.origin + '/api/v1/evaluate',

    init: function(config) {
      this.config = config || {};

      if (!this.config.apiKey) {
        console.error('FormBlocker: API key is required');
        return;
      }

      if (this.config.debug) {
        console.log('FormBlocker: Initialized with config:', this.config);
      }

      this.attachToForms();
    },

    attachToForms: function() {
      var selector = this.config.selector || 'form';
      var forms = document.querySelectorAll(selector);

      if (this.config.debug) {
        console.log('FormBlocker: Found ' + forms.length + ' forms');
      }

      for (var i = 0; i < forms.length; i++) {
        if (!forms[i].hasAttribute('data-fb-attached')) {
          forms[i].setAttribute('data-fb-attached', 'true');
          this.attachToForm(forms[i]);
        }
      }
    },

    attachToForm: function(form) {
      var self = this;
      var originalSubmit = form.onsubmit;

      // 行動データの追跡
      var behavioralData = {
        pasteDetected: false,
        timeToSubmit: null,
        pageLoadTime: Date.now()
      };

      // ペースト検出
      var inputs = form.querySelectorAll('input, textarea');
      for (var i = 0; i < inputs.length; i++) {
        inputs[i].addEventListener('paste', function() {
          behavioralData.pasteDetected = true;
          if (self.config.debug) {
            console.log('FormBlocker: Paste detected');
          }
        });
      }

      // 送信イベントをインターセプト
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();

        behavioralData.timeToSubmit = (Date.now() - behavioralData.pageLoadTime) / 1000;

        if (self.config.debug) {
          console.log('FormBlocker: Form submission intercepted');
        }

        self.handleSubmit(form, behavioralData, originalSubmit);
      }, true);
    },

    handleSubmit: function(form, behavioralData, originalSubmit) {
      var self = this;
      var formData = this.extractFormData(form);

      if (this.config.debug) {
        console.log('FormBlocker: Submitting to API', formData);
      }

      // ローディング表示
      this.showLoading(form);

      // API呼び出し
      fetch(this.apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          api_key: this.config.apiKey,
          form_data: formData,
          metadata: {
            url: window.location.href,
            user_agent: navigator.userAgent,
            timestamp: Date.now()
          },
          behavioral_data: {
            paste_detected: behavioralData.pasteDetected,
            time_to_submit: behavioralData.timeToSubmit
          }
        })
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(result) {
        self.hideLoading(form);
        self.handleResult(result, form, originalSubmit);
      })
      .catch(function(error) {
        console.error('FormBlocker: API error', error);
        self.hideLoading(form);
        // エラー時はフォールバック: 送信を許可
        self.allowSubmission(form, originalSubmit);
      });
    },

    extractFormData: function(form) {
      var data = {};
      var elements = form.elements;

      for (var i = 0; i < elements.length; i++) {
        var element = elements[i];
        if (element.name && element.value) {
          data[element.name] = element.value;
        }
      }

      return data;
    },

    handleResult: function(result, form, originalSubmit) {
      if (this.config.debug) {
        console.log('FormBlocker: Result', result);
      }

      switch (result.decision) {
        case 'allow':
          this.allowSubmission(form, originalSubmit);
          if (this.config.onAllow) {
            this.config.onAllow(result);
          }
          break;

        case 'challenge':
          this.showChallenge(result, form, originalSubmit);
          break;

        case 'hold':
          this.showMessage('送信内容を確認中です。しばらくお待ちください。', 'info');
          break;

        case 'block':
          this.showMessage(result.message, 'error');
          if (this.config.onBlock) {
            this.config.onBlock(result);
          }
          break;
      }
    },

    allowSubmission: function(form, originalSubmit) {
      // 一時的にバイパスフラグを設定
      form.setAttribute('data-fb-bypass', 'true');

      if (originalSubmit) {
        originalSubmit.call(form);
      } else {
        form.submit();
      }
    },

    showChallenge: function(result, form, originalSubmit) {
      var self = this;

      if (this.config.onChallenge) {
        this.config.onChallenge(result);
        return;
      }

      var message = result.challenge && result.challenge.question
        ? result.challenge.question
        : '営業目的ではないことを確認してください';

      var confirmed = confirm(message + '\n\n「OK」を押すと送信されます。');

      if (confirmed) {
        this.allowSubmission(form, originalSubmit);
      }
    },

    showMessage: function(message, type) {
      var className = type === 'error' ? 'fb-error' : 'fb-info';
      var div = document.createElement('div');
      div.className = 'fb-message ' + className;
      div.textContent = message;
      div.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);' +
        'padding:16px 24px;border-radius:8px;background:' +
        (type === 'error' ? '#ef4444' : '#3b82f6') + ';color:white;' +
        'box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:10000;font-family:sans-serif;';

      document.body.appendChild(div);

      setTimeout(function() {
        div.style.transition = 'opacity 0.3s';
        div.style.opacity = '0';
        setTimeout(function() {
          document.body.removeChild(div);
        }, 300);
      }, 3000);
    },

    showLoading: function(form) {
      var overlay = document.createElement('div');
      overlay.className = 'fb-loading';
      overlay.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;' +
        'background:rgba(255,255,255,0.8);display:flex;align-items:center;' +
        'justify-content:center;z-index:1000;';
      overlay.innerHTML = '<div style="text-align:center;"><div style="border:4px solid #f3f4f6;' +
        'border-top:4px solid #3b82f6;border-radius:50%;width:40px;height:40px;' +
        'animation:spin 1s linear infinite;"></div></div>';

      form.style.position = 'relative';
      form.appendChild(overlay);

      // アニメーション定義
      if (!document.getElementById('fb-styles')) {
        var style = document.createElement('style');
        style.id = 'fb-styles';
        style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } ' +
          '100% { transform: rotate(360deg); } }';
        document.head.appendChild(style);
      }
    },

    hideLoading: function(form) {
      var loading = form.querySelector('.fb-loading');
      if (loading) {
        form.removeChild(loading);
      }
    }
  };

  // グローバルに公開
  window.FormBlocker = FormBlocker;

  // DOMContentLoaded後に自動初期化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      if (window.FormBlockerAutoInit) {
        FormBlocker.init(window.FormBlockerAutoInit);
      }
    });
  }
})();
