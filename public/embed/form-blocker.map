{"version":3,"file":"form-blocker","sources":["../../embed-script/src/index.ts"],"sourcesContent":["type SubmissionDecision = 'allowed' | 'challenged' | 'held' | 'blocked';\n\ninterface ChallengePayload {\n  type?: string;\n  question?: string;\n}\n\ninterface EvaluateSuccessResponse {\n  success: true;\n  decision: SubmissionDecision;\n  message: string;\n  submission_id?: string;\n  scores?: {\n    sales: number;\n    spam: number;\n  };\n  reasons?: string[];\n  challenge?: ChallengePayload;\n}\n\ninterface EvaluateErrorResponse {\n  success: false;\n  error: {\n    code?: string;\n    message?: string;\n  };\n}\n\ntype EvaluateResponsePayload = EvaluateSuccessResponse | EvaluateErrorResponse;\n\ninterface DetectionSnapshot {\n  urlDetected: boolean;\n  detectedUrls: string[];\n  salesKeywords: string[];\n  bannedKeywords: string[];\n  pasteDetected: boolean;\n  contentLength: number;\n  updatedAt: number;\n}\n\nexport interface FormBlockerInitOptions {\n  apiKey: string;\n  apiBaseUrl?: string;\n  evaluatePath?: string;\n  selector?: string;\n  debug?: boolean;\n  previewMode?: boolean;\n  debugRules?: {\n    salesKeywords?: string[];\n    bannedKeywords?: string[];\n  };\n  onAllow?: (result: EvaluateSuccessResponse) => void;\n  onBlock?: (result: EvaluateSuccessResponse) => void;\n  onChallenge?: (result: EvaluateSuccessResponse, allow: () => void) => void;\n  onHold?: (result: EvaluateSuccessResponse) => void;\n  onError?: (error: unknown) => void;\n  onDetectionUpdate?: (snapshot: DetectionSnapshot) => void;\n}\n\ninterface InternalConfig {\n  apiKey: string;\n  evaluateUrl: string;\n  selector: string;\n  debug: boolean;\n  previewMode: boolean;\n  salesKeywords: string[];\n  bannedKeywords: string[];\n  onAllow?: FormBlockerInitOptions['onAllow'];\n  onBlock?: FormBlockerInitOptions['onBlock'];\n  onChallenge?: FormBlockerInitOptions['onChallenge'];\n  onHold?: FormBlockerInitOptions['onHold'];\n  onError?: FormBlockerInitOptions['onError'];\n  onDetectionUpdate?: FormBlockerInitOptions['onDetectionUpdate'];\n}\n\ninterface BehavioralSnapshot {\n  pasteDetected: boolean;\n  timeToSubmit: number | null;\n  pageLoadTime: number;\n}\n\ninterface FormContext {\n  originalSubmit: ((this: HTMLFormElement, ev: SubmitEvent) => unknown) | null;\n  submitHandler: EventListener;\n  pasteHandlers: Array<{ element: Element; handler: EventListener }>;\n  inputHandlers: Array<{ element: Element; handler: EventListener }>;\n  behavioral: BehavioralSnapshot;\n  lastDetection?: DetectionSnapshot;\n}\n\nconst DEFAULT_SALES_KEYWORDS = ['営業', 'セールス', '提案', '御社', '貴社', '販売', '広告', '代理店'];\nconst DEFAULT_BANNED_KEYWORDS = ['無料', '限定', '販売促進', '広告代理店'];\n\nfunction resolveEvaluateUrl(options: FormBlockerInitOptions): string {\n  const baseUrl =\n    (options.apiBaseUrl && options.apiBaseUrl.trim()) ||\n    (typeof window !== 'undefined' ? window.location.origin : '');\n  const trimmedBase = baseUrl.replace(/\\/+$/, '');\n  const evaluatePath = (options.evaluatePath || '/api/v1/evaluate').trim() || '/api/v1/evaluate';\n  if (/^https?:\\/\\//i.test(evaluatePath)) {\n    return evaluatePath;\n  }\n  return `${trimmedBase}${evaluatePath.startsWith('/') ? evaluatePath : `/${evaluatePath}`}`;\n}\n\nfunction createOverlay(): HTMLDivElement {\n  const overlay = document.createElement('div');\n  overlay.className = 'fb-loading';\n  overlay.style.cssText = [\n    'position:absolute',\n    'top:0',\n    'left:0',\n    'right:0',\n    'bottom:0',\n    'background:rgba(255,255,255,0.8)',\n    'display:flex',\n    'align-items:center',\n    'justify-content:center',\n    'z-index:1000',\n  ].join(';');\n\n  const spinner = document.createElement('div');\n  spinner.style.cssText = [\n    'border:4px solid #f3f4f6',\n    'border-top:4px solid #3b82f6',\n    'border-radius:50%',\n    'width:40px',\n    'height:40px',\n    'animation:fb-spin 1s linear infinite',\n  ].join(';');\n\n  overlay.appendChild(spinner);\n\n  if (!document.getElementById('fb-styles')) {\n    const style = document.createElement('style');\n    style.id = 'fb-styles';\n    style.textContent =\n      '@keyframes fb-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';\n    document.head.appendChild(style);\n  }\n\n  return overlay;\n}\n\nfunction showBanner(message: string, type: 'info' | 'error'): void {\n  const div = document.createElement('div');\n  div.className = `fb-message fb-${type}`;\n  div.textContent = message;\n  div.style.cssText = [\n    'position:fixed',\n    'top:20px',\n    'left:50%',\n    'transform:translateX(-50%)',\n    'padding:16px 24px',\n    'border-radius:8px',\n    `background:${type === 'error' ? '#ef4444' : '#3b82f6'}`,\n    'color:white',\n    'box-shadow:0 4px 6px rgba(0,0,0,0.1)',\n    'z-index:10000',\n    'font-family:sans-serif',\n  ].join(';');\n\n  document.body.appendChild(div);\n\n  setTimeout(() => {\n    div.style.transition = 'opacity 0.3s';\n    div.style.opacity = '0';\n    setTimeout(() => {\n      if (div.parentElement) {\n        div.parentElement.removeChild(div);\n      }\n    }, 300);\n  }, 3000);\n}\n\nclass FormBlockerCore {\n  private config: InternalConfig | null = null;\n  private contexts = new Map<HTMLFormElement, FormContext>();\n\n  init(options: FormBlockerInitOptions): void {\n    if (typeof window === 'undefined' || typeof document === 'undefined') {\n      return;\n    }\n\n    if (!options || !options.apiKey) {\n      console.error('[FormBlocker] apiKey is required');\n      return;\n    }\n\n    this.destroy();\n\n    const normalizeKeywords = (keywords: string[]) => keywords.map((kw) => kw.toLowerCase());\n\n    this.config = {\n      apiKey: options.apiKey,\n      evaluateUrl: resolveEvaluateUrl(options),\n      selector: options.selector || 'form',\n      debug: Boolean(options.debug),\n      previewMode: Boolean(options.previewMode),\n      salesKeywords: options.debugRules?.salesKeywords?.length\n        ? normalizeKeywords(options.debugRules.salesKeywords)\n        : normalizeKeywords(DEFAULT_SALES_KEYWORDS),\n      bannedKeywords: options.debugRules?.bannedKeywords?.length\n        ? normalizeKeywords(options.debugRules.bannedKeywords)\n        : normalizeKeywords(DEFAULT_BANNED_KEYWORDS),\n      onAllow: options.onAllow,\n      onBlock: options.onBlock,\n      onChallenge: options.onChallenge,\n      onHold: options.onHold,\n      onError: options.onError,\n      onDetectionUpdate: options.onDetectionUpdate,\n    };\n\n    this.log('Initialized with config', this.config);\n    this.attachToForms();\n  }\n\n  refresh(): void {\n    if (!this.config) {\n      this.log('Refresh skipped: config not initialized');\n      return;\n    }\n    this.attachToForms();\n  }\n\n  destroy(): void {\n    this.contexts.forEach((context, form) => {\n      form.removeAttribute('data-fb-attached');\n      form.removeEventListener('submit', context.submitHandler, true);\n      context.pasteHandlers.forEach(({ element, handler }) => {\n        element.removeEventListener('paste', handler);\n      });\n      context.inputHandlers.forEach(({ element, handler }) => {\n        element.removeEventListener('input', handler);\n      });\n    });\n    this.contexts.clear();\n  }\n\n  private attachToForms(): void {\n    if (!this.config) {\n      return;\n    }\n\n    const forms = document.querySelectorAll<HTMLFormElement>(this.config.selector);\n    forms.forEach((form) => {\n      if (this.contexts.has(form)) {\n        return;\n      }\n      this.attachToForm(form);\n    });\n  }\n\n  private attachToForm(form: HTMLFormElement): void {\n    if (!this.config) {\n      return;\n    }\n\n    const behavioral: BehavioralSnapshot = {\n      pasteDetected: false,\n      timeToSubmit: null,\n      pageLoadTime: Date.now(),\n    };\n\n    const submitHandler = (event: Event) => {\n      this.handleSubmit(event as SubmitEvent, form, behavioral).catch((error) => {\n        this.log('Submission handling failed', error);\n      });\n    };\n\n    const pasteHandlers: Array<{ element: Element; handler: EventListener }> = [];\n    const inputHandlers: Array<{ element: Element; handler: EventListener }> = [];\n    const inputElements = form.querySelectorAll('input, textarea');\n    inputElements.forEach((element) => {\n      const handler = () => {\n        behavioral.pasteDetected = true;\n        this.log('Paste detected for form', form);\n        this.emitDetectionUpdate(form, behavioral);\n      };\n      element.addEventListener('paste', handler);\n      pasteHandlers.push({ element, handler });\n    });\n\n    inputElements.forEach((element) => {\n      const handler = () => {\n        this.emitDetectionUpdate(form, behavioral);\n      };\n      element.addEventListener('input', handler);\n      inputHandlers.push({ element, handler });\n    });\n\n    form.addEventListener('submit', submitHandler, true);\n    form.setAttribute('data-fb-attached', 'true');\n\n    this.emitDetectionUpdate(form, behavioral);\n\n    this.contexts.set(form, {\n      originalSubmit: form.onsubmit,\n      submitHandler,\n      pasteHandlers,\n      inputHandlers,\n      behavioral,\n    });\n\n    this.log('Attached to form', form);\n  }\n\n  private async handleSubmit(\n    event: SubmitEvent,\n    form: HTMLFormElement,\n    behavioral: BehavioralSnapshot\n  ): Promise<void> {\n    if (!this.config) {\n      return;\n    }\n\n    event.preventDefault();\n    event.stopPropagation();\n\n    behavioral.timeToSubmit = (Date.now() - behavioral.pageLoadTime) / 1000;\n\n    this.showLoading(form);\n\n    this.emitDetectionUpdate(form, behavioral);\n\n    try {\n      const payload = this.buildRequestBody(form, behavioral);\n      this.log('Submitting payload', payload);\n\n      const response = await fetch(this.config.evaluateUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        throw new Error(`API request failed with status ${response.status}`);\n      }\n\n      const result = (await response.json()) as EvaluateResponsePayload;\n      this.log('Received response', result);\n\n      if (!result.success) {\n        const message = result.error?.message || 'エラーが発生しました。後ほど再度お試しください。';\n        showBanner(message, 'error');\n        this.config.onError?.(result);\n        this.hideLoading(form);\n        return;\n      }\n\n      this.handleDecision(result, form);\n    } catch (error) {\n      console.error('[FormBlocker] API error', error);\n      this.config.onError?.(error);\n      this.hideLoading(form);\n      this.allowSubmission(form);\n    }\n  }\n\n  private buildRequestBody(form: HTMLFormElement, behavioral: BehavioralSnapshot) {\n    const metadata = {\n      url: typeof window !== 'undefined' ? window.location.href : '',\n      user_agent: typeof navigator !== 'undefined' ? navigator.userAgent : '',\n      timestamp: Date.now(),\n    };\n\n    const behavioralData: Record<string, unknown> = {\n      paste_detected: behavioral.pasteDetected,\n    };\n\n    if (typeof behavioral.timeToSubmit === 'number' && !Number.isNaN(behavioral.timeToSubmit)) {\n      behavioralData.time_to_submit = behavioral.timeToSubmit;\n    }\n\n    return {\n      api_key: this.config?.apiKey,\n      form_data: this.extractFormData(form),\n      metadata,\n      behavioral_data: behavioralData,\n    };\n  }\n\n  private extractFormData(form: HTMLFormElement): Record<string, unknown> {\n    const data: Record<string, unknown> = {};\n    const elements = Array.from(form.elements) as Array<HTMLInputElement | HTMLTextAreaElement>;\n\n    elements.forEach((element) => {\n      if (!element.name) {\n        return;\n      }\n\n      const type = (element as HTMLInputElement).type;\n      if (type === 'checkbox') {\n        const input = element as HTMLInputElement;\n        if (!data[element.name]) {\n          data[element.name] = [];\n        }\n        if (input.checked) {\n          (data[element.name] as unknown[]).push(input.value);\n        }\n        return;\n      }\n\n      if (type === 'radio') {\n        const input = element as HTMLInputElement;\n        if (input.checked) {\n          data[element.name] = input.value;\n        } else if (!(element.name in data)) {\n          data[element.name] = null;\n        }\n        return;\n      }\n\n      data[element.name] = element.value;\n    });\n\n    return data;\n  }\n\n  private handleDecision(result: EvaluateSuccessResponse, form: HTMLFormElement): void {\n    switch (result.decision) {\n      case 'allowed':\n        this.allowSubmission(form);\n        this.hideLoading(form);\n        this.config?.onAllow?.(result);\n        break;\n      case 'challenged':\n        this.hideLoading(form);\n        this.handleChallenge(result, form);\n        break;\n      case 'held':\n        this.hideLoading(form);\n        showBanner(result.message, 'info');\n        this.config?.onHold?.(result);\n        break;\n      case 'blocked':\n        this.hideLoading(form);\n        showBanner(result.message, 'error');\n        this.config?.onBlock?.(result);\n        break;\n      default:\n        this.hideLoading(form);\n        this.allowSubmission(form);\n    }\n  }\n\n  private handleChallenge(result: EvaluateSuccessResponse, form: HTMLFormElement): void {\n    const allow = () => {\n      this.allowSubmission(form);\n      this.config?.onAllow?.(result);\n    };\n\n    if (this.config?.onChallenge) {\n      this.config.onChallenge(result, allow);\n      return;\n    }\n\n    const question =\n      result.challenge?.question || 'この送信は営業目的ではありませんか？送信を続けますか？';\n    const confirmed = window.confirm(`${question}\\n\\n「OK」を押すと送信されます。`);\n    if (confirmed) {\n      allow();\n    }\n  }\n\n  private allowSubmission(form: HTMLFormElement): void {\n    if (this.config?.previewMode) {\n      return;\n    }\n    const context = this.contexts.get(form);\n    if (context?.originalSubmit) {\n      const event = new Event('submit', { bubbles: true, cancelable: true });\n      context.originalSubmit.call(form, event as SubmitEvent);\n    } else {\n      form.submit();\n    }\n  }\n\n  private showLoading(form: HTMLFormElement): void {\n    if (!form.querySelector('.fb-loading')) {\n      const overlay = createOverlay();\n      const style = window.getComputedStyle(form);\n      if (style.position === 'static' || !style.position) {\n        form.style.position = 'relative';\n      }\n      form.appendChild(overlay);\n    }\n  }\n\n  private hideLoading(form: HTMLFormElement): void {\n    const overlay = form.querySelector('.fb-loading');\n    if (overlay && overlay.parentElement) {\n      overlay.parentElement.removeChild(overlay);\n    }\n  }\n\n  private log(message: string, payload?: unknown): void {\n    if (!this.config?.debug) return;\n    if (payload !== undefined) {\n      console.log(`[FormBlocker] ${message}`, payload);\n    } else {\n      console.log(`[FormBlocker] ${message}`);\n    }\n  }\n\n  private emitDetectionUpdate(form: HTMLFormElement, behavioral: BehavioralSnapshot): void {\n    if (!this.config?.onDetectionUpdate) {\n      return;\n    }\n\n    const context = this.contexts.get(form);\n    const formData = this.extractFormData(form);\n    const snapshot = this.analyzeDetection(formData, behavioral);\n\n    context && (context.lastDetection = snapshot);\n\n    this.config.onDetectionUpdate(snapshot);\n  }\n\n  private analyzeDetection(formData: Record<string, unknown>, behavioral: BehavioralSnapshot): DetectionSnapshot {\n    const textFragments = Object.values(formData).map((value) => {\n      if (typeof value === 'string') return value;\n      if (Array.isArray(value)) return value.join(' ');\n      return '';\n    });\n\n    const values = textFragments.join(' ').toLowerCase();\n\n    const urlRegex = /(https?:\\/\\/[^\\s]+)/gi;\n    const detectedUrls = values.match(urlRegex) || [];\n\n    const salesKeywords = this.config?.salesKeywords || DEFAULT_SALES_KEYWORDS;\n    const bannedKeywords = this.config?.bannedKeywords || DEFAULT_BANNED_KEYWORDS;\n\n    const detectedSales = salesKeywords.filter((kw) => kw && values.includes(kw.toLowerCase()));\n    const detectedBanned = bannedKeywords.filter((kw) => kw && values.includes(kw.toLowerCase()));\n\n    return {\n      urlDetected: detectedUrls.length > 0,\n      detectedUrls,\n      salesKeywords: detectedSales,\n      bannedKeywords: detectedBanned,\n      pasteDetected: behavioral.pasteDetected,\n      contentLength: values.length,\n      updatedAt: Date.now(),\n    };\n  }\n}\n\nconst core = new FormBlockerCore();\n\nexport const FormBlocker = {\n  init(options: FormBlockerInitOptions): void {\n    core.init(options);\n  },\n  refresh(): void {\n    core.refresh();\n  },\n  destroy(): void {\n    core.destroy();\n  },\n};\n\ndeclare global {\n  interface Window {\n    FormBlocker?: typeof FormBlocker;\n    FormBlockerAutoInit?: FormBlockerInitOptions;\n  }\n}\n\nif (typeof window !== 'undefined') {\n  window.FormBlocker = FormBlocker;\n\n  const autoInit = window.FormBlockerAutoInit;\n  if (autoInit) {\n    FormBlocker.init(autoInit);\n  }\n\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n      const pendingConfig = window.FormBlockerAutoInit;\n      if (pendingConfig) {\n        FormBlocker.init(pendingConfig);\n      }\n    });\n  }\n}\n\nexport default FormBlocker;\n"],"names":["DEFAULT_SALES_KEYWORDS","DEFAULT_BANNED_KEYWORDS","resolveEvaluateUrl","options","trimmedBase","evaluatePath","createOverlay","overlay","spinner","style","showBanner","message","type","div","FormBlockerCore","normalizeKeywords","keywords","kw","_b","_a","_d","_c","context","form","element","handler","behavioral","submitHandler","event","error","pasteHandlers","inputHandlers","inputElements","payload","response","result","_e","metadata","behavioralData","data","input","_f","allow","question","formData","snapshot","values","value","urlRegex","detectedUrls","salesKeywords","bannedKeywords","detectedSales","detectedBanned","core","FormBlocker","autoInit","pendingConfig"],"mappings":"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"}