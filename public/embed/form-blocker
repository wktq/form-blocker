var FormBlocker=function(g){"use strict";const y=["営業","セールス","提案","御社","貴社","販売","広告","代理店"],w=["無料","限定","販売促進","広告代理店"];function v(c){const e=(c.apiBaseUrl&&c.apiBaseUrl.trim()||(typeof window<"u"?window.location.origin:"")).replace(/\/+$/,""),n=(c.evaluatePath||"/api/v1/evaluate").trim()||"/api/v1/evaluate";return/^https?:\/\//i.test(n)?n:`${e}${n.startsWith("/")?n:`/${n}`}`}function E(){const c=document.createElement("div");c.className="fb-loading",c.style.cssText=["position:absolute","top:0","left:0","right:0","bottom:0","background:rgba(255,255,255,0.8)","display:flex","align-items:center","justify-content:center","z-index:1000"].join(";");const t=document.createElement("div");if(t.style.cssText=["border:4px solid #f3f4f6","border-top:4px solid #3b82f6","border-radius:50%","width:40px","height:40px","animation:fb-spin 1s linear infinite"].join(";"),c.appendChild(t),!document.getElementById("fb-styles")){const e=document.createElement("style");e.id="fb-styles",e.textContent="@keyframes fb-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }",document.head.appendChild(e)}return c}function p(c,t){const e=document.createElement("div");e.className=`fb-message fb-${t}`,e.textContent=c,e.style.cssText=["position:fixed","top:20px","left:50%","transform:translateX(-50%)","padding:16px 24px","border-radius:8px",`background:${t==="error"?"#ef4444":"#3b82f6"}`,"color:white","box-shadow:0 4px 6px rgba(0,0,0,0.1)","z-index:10000","font-family:sans-serif"].join(";"),document.body.appendChild(e),setTimeout(()=>{e.style.transition="opacity 0.3s",e.style.opacity="0",setTimeout(()=>{e.parentElement&&e.parentElement.removeChild(e)},300)},3e3)}class D{constructor(){this.config=null,this.contexts=new Map}init(t){var n,i,s,o;if(typeof window>"u"||typeof document>"u")return;if(!t||!t.apiKey){console.error("[FormBlocker] apiKey is required");return}this.destroy();const e=a=>a.map(r=>r.toLowerCase());this.config={apiKey:t.apiKey,evaluateUrl:v(t),selector:t.selector||"form",debug:!!t.debug,previewMode:!!t.previewMode,salesKeywords:(i=(n=t.debugRules)==null?void 0:n.salesKeywords)!=null&&i.length?e(t.debugRules.salesKeywords):e(y),bannedKeywords:(o=(s=t.debugRules)==null?void 0:s.bannedKeywords)!=null&&o.length?e(t.debugRules.bannedKeywords):e(w),onAllow:t.onAllow,onBlock:t.onBlock,onChallenge:t.onChallenge,onHold:t.onHold,onError:t.onError,onDetectionUpdate:t.onDetectionUpdate},this.log("Initialized with config",this.config),this.attachToForms()}refresh(){if(!this.config){this.log("Refresh skipped: config not initialized");return}this.attachToForms()}destroy(){this.contexts.forEach((t,e)=>{e.removeAttribute("data-fb-attached"),e.removeEventListener("submit",t.submitHandler,!0),t.pasteHandlers.forEach(({element:n,handler:i})=>{n.removeEventListener("paste",i)}),t.inputHandlers.forEach(({element:n,handler:i})=>{n.removeEventListener("input",i)})}),this.contexts.clear()}attachToForms(){if(!this.config)return;document.querySelectorAll(this.config.selector).forEach(e=>{this.contexts.has(e)||this.attachToForm(e)})}attachToForm(t){if(!this.config)return;const e={pasteDetected:!1,timeToSubmit:null,pageLoadTime:Date.now()},n=a=>{this.handleSubmit(a,t,e).catch(r=>{this.log("Submission handling failed",r)})},i=[],s=[],o=t.querySelectorAll("input, textarea");o.forEach(a=>{const r=()=>{e.pasteDetected=!0,this.log("Paste detected for form",t),this.emitDetectionUpdate(t,e)};a.addEventListener("paste",r),i.push({element:a,handler:r})}),o.forEach(a=>{const r=()=>{this.emitDetectionUpdate(t,e)};a.addEventListener("input",r),s.push({element:a,handler:r})}),t.addEventListener("submit",n,!0),t.setAttribute("data-fb-attached","true"),this.emitDetectionUpdate(t,e),this.contexts.set(t,{originalSubmit:t.onsubmit,submitHandler:n,pasteHandlers:i,inputHandlers:s,behavioral:e}),this.log("Attached to form",t)}async handleSubmit(t,e,n){var i,s,o,a,r;if(this.config){t.preventDefault(),t.stopPropagation(),n.timeToSubmit=(Date.now()-n.pageLoadTime)/1e3,this.showLoading(e),this.emitDetectionUpdate(e,n);try{const d=this.buildRequestBody(e,n);this.log("Submitting payload",d);const f=await fetch(this.config.evaluateUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!f.ok)throw new Error(`API request failed with status ${f.status}`);const u=await f.json();if(this.log("Received response",u),!u.success){const m=((i=u.error)==null?void 0:i.message)||"エラーが発生しました。後ほど再度お試しください。";p(m,"error"),(o=(s=this.config).onError)==null||o.call(s,u),this.hideLoading(e);return}this.handleDecision(u,e)}catch(d){console.error("[FormBlocker] API error",d),(r=(a=this.config).onError)==null||r.call(a,d),this.hideLoading(e),this.allowSubmission(e)}}}buildRequestBody(t,e){var s;const n={url:typeof window<"u"?window.location.href:"",user_agent:typeof navigator<"u"?navigator.userAgent:"",timestamp:Date.now()},i={paste_detected:e.pasteDetected};return typeof e.timeToSubmit=="number"&&!Number.isNaN(e.timeToSubmit)&&(i.time_to_submit=e.timeToSubmit),{api_key:(s=this.config)==null?void 0:s.apiKey,form_data:this.extractFormData(t),metadata:n,behavioral_data:i}}extractFormData(t){const e={};return Array.from(t.elements).forEach(i=>{if(!i.name)return;const s=i.type;if(s==="checkbox"){const o=i;e[i.name]||(e[i.name]=[]),o.checked&&e[i.name].push(o.value);return}if(s==="radio"){const o=i;o.checked?e[i.name]=o.value:i.name in e||(e[i.name]=null);return}e[i.name]=i.value}),e}handleDecision(t,e){var n,i,s,o,a,r;switch(t.decision){case"allowed":this.allowSubmission(e),this.hideLoading(e),(i=(n=this.config)==null?void 0:n.onAllow)==null||i.call(n,t);break;case"challenged":this.hideLoading(e),this.handleChallenge(t,e);break;case"held":this.hideLoading(e),p(t.message,"info"),(o=(s=this.config)==null?void 0:s.onHold)==null||o.call(s,t);break;case"blocked":this.hideLoading(e),p(t.message,"error"),(r=(a=this.config)==null?void 0:a.onBlock)==null||r.call(a,t);break;default:this.hideLoading(e),this.allowSubmission(e)}}handleChallenge(t,e){var o,a;const n=()=>{var r,d;this.allowSubmission(e),(d=(r=this.config)==null?void 0:r.onAllow)==null||d.call(r,t)};if((o=this.config)!=null&&o.onChallenge){this.config.onChallenge(t,n);return}const i=((a=t.challenge)==null?void 0:a.question)||"この送信は営業目的ではありませんか？送信を続けますか？";window.confirm(`${i}

「OK」を押すと送信されます。`)&&n()}allowSubmission(t){var n;if((n=this.config)!=null&&n.previewMode)return;const e=this.contexts.get(t);if(e!=null&&e.originalSubmit){const i=new Event("submit",{bubbles:!0,cancelable:!0});e.originalSubmit.call(t,i)}else t.submit()}showLoading(t){if(!t.querySelector(".fb-loading")){const e=E(),n=window.getComputedStyle(t);(n.position==="static"||!n.position)&&(t.style.position="relative"),t.appendChild(e)}}hideLoading(t){const e=t.querySelector(".fb-loading");e&&e.parentElement&&e.parentElement.removeChild(e)}log(t,e){var n;(n=this.config)!=null&&n.debug&&(e!==void 0?console.log(`[FormBlocker] ${t}`,e):console.log(`[FormBlocker] ${t}`))}emitDetectionUpdate(t,e){var o;if(!((o=this.config)!=null&&o.onDetectionUpdate))return;const n=this.contexts.get(t),i=this.extractFormData(t),s=this.analyzeDetection(i,e);n&&(n.lastDetection=s),this.config.onDetectionUpdate(s)}analyzeDetection(t,e){var u,m;const i=Object.values(t).map(l=>typeof l=="string"?l:Array.isArray(l)?l.join(" "):"").join(" ").toLowerCase(),s=/(https?:\/\/[^\s]+)/gi,o=i.match(s)||[],a=((u=this.config)==null?void 0:u.salesKeywords)||y,r=((m=this.config)==null?void 0:m.bannedKeywords)||w,d=a.filter(l=>l&&i.includes(l.toLowerCase())),f=r.filter(l=>l&&i.includes(l.toLowerCase()));return{urlDetected:o.length>0,detectedUrls:o,salesKeywords:d,bannedKeywords:f,pasteDetected:e.pasteDetected,contentLength:i.length,updatedAt:Date.now()}}}const b=new D,h={init(c){b.init(c)},refresh(){b.refresh()},destroy(){b.destroy()}};if(typeof window<"u"){window.FormBlocker=h;const c=window.FormBlockerAutoInit;c&&h.init(c),document.readyState==="loading"&&document.addEventListener("DOMContentLoaded",()=>{const t=window.FormBlockerAutoInit;t&&h.init(t)})}return g.FormBlocker=h,g.default=h,Object.defineProperties(g,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}}),g}({});
//# sourceMappingURL=form-blocker.map
