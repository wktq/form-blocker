{"version":3,"file":"form-blocker.mjs","sources":["../../embed-script/src/index.ts"],"sourcesContent":["type SubmissionDecision = 'allowed' | 'challenged' | 'held' | 'blocked';\n\ninterface ChallengePayload {\n  type?: string;\n  question?: string;\n}\n\ninterface EvaluateSuccessResponse {\n  success: true;\n  decision: SubmissionDecision;\n  message: string;\n  submission_id?: string;\n  scores?: {\n    sales: number;\n    spam: number;\n  };\n  reasons?: string[];\n  challenge?: ChallengePayload;\n}\n\ninterface EvaluateErrorResponse {\n  success: false;\n  error: {\n    code?: string;\n    message?: string;\n  };\n}\n\ntype EvaluateResponsePayload = EvaluateSuccessResponse | EvaluateErrorResponse;\n\ninterface DetectionSnapshot {\n  urlDetected: boolean;\n  detectedUrls: string[];\n  schedulingUrls: string[];\n  salesKeywords: string[];\n  bannedKeywords: string[];\n  blockedDomains: string[];\n  pasteDetected: boolean;\n  contentLength: number;\n  updatedAt: number;\n}\n\nexport interface FormBlockerInitOptions {\n  apiKey: string;\n  apiBaseUrl?: string;\n  evaluatePath?: string;\n  selector?: string;\n  debug?: boolean;\n  previewMode?: boolean;\n  debugRules?: {\n    salesKeywords?: string[];\n    bannedKeywords?: string[];\n    blockedDomains?: string[];\n  };\n  onAllow?: (result: EvaluateSuccessResponse) => void;\n  onBlock?: (result: EvaluateSuccessResponse) => void;\n  onChallenge?: (result: EvaluateSuccessResponse, allow: () => void) => void;\n  onHold?: (result: EvaluateSuccessResponse) => void;\n  onError?: (error: unknown) => void;\n  onDetectionUpdate?: (snapshot: DetectionSnapshot) => void;\n}\n\ninterface InternalConfig {\n  apiKey: string;\n  evaluateUrl: string;\n  selector: string;\n  debug: boolean;\n  previewMode: boolean;\n  salesKeywords: string[];\n  bannedKeywords: string[];\n  blockedDomains: string[];\n  onAllow?: FormBlockerInitOptions['onAllow'];\n  onBlock?: FormBlockerInitOptions['onBlock'];\n  onChallenge?: FormBlockerInitOptions['onChallenge'];\n  onHold?: FormBlockerInitOptions['onHold'];\n  onError?: FormBlockerInitOptions['onError'];\n  onDetectionUpdate?: FormBlockerInitOptions['onDetectionUpdate'];\n}\n\ninterface BehavioralSnapshot {\n  pasteDetected: boolean;\n  timeToSubmit: number | null;\n  pageLoadTime: number;\n}\n\ninterface FormContext {\n  originalSubmit: ((this: HTMLFormElement, ev: SubmitEvent) => unknown) | null;\n  submitHandler: EventListener;\n  pasteHandlers: Array<{ element: Element; handler: EventListener }>;\n  inputHandlers: Array<{ element: Element; handler: EventListener }>;\n  behavioral: BehavioralSnapshot;\n  lastDetection?: DetectionSnapshot;\n}\n\nconst FORM_BLOCKER_VERSION = '2024-11-07-block-modal';\n\nconst DEFAULT_SALES_KEYWORDS = ['営業', 'セールス', '提案', '御社', '貴社', '販売', '広告', '代理店'];\nconst DEFAULT_BANNED_KEYWORDS = ['無料', '限定', '販売促進', '広告代理店'];\nconst DEFAULT_SCHEDULING_DOMAINS = [\n  'calendly.com',\n  'youcanbook.me',\n  'scheduleonce.com',\n  'acuityscheduling.com',\n  'savvycal.com',\n  'hubspot.com',\n  'meetings.hubspot.com',\n  'tidycal.com',\n  'cal.com',\n];\n\nfunction normalizeDomain(domain: string): string {\n  return domain.trim().toLowerCase();\n}\n\nfunction matchesDomain(domain: string, target: string): boolean {\n  return domain === target || domain.endsWith(`.${target}`);\n}\n\nfunction extractHostname(url: string): string | null {\n  try {\n    return new URL(url).hostname.toLowerCase();\n  } catch {\n    const match = url.match(/https?:\\/\\/([^/\\s]+)/i);\n    return match?.[1]?.toLowerCase() ?? null;\n  }\n}\n\nfunction collectEmailDomains(formData: Record<string, unknown>): string[] {\n  const domains = new Set<string>();\n  const regex = /[\\w.+-]+@([A-Za-z0-9.-]+\\.[A-Za-z]{2,})/g;\n  Object.values(formData).forEach((value) => {\n    if (typeof value !== 'string') {\n      return;\n    }\n    const matches = value.matchAll(regex);\n    for (const match of matches) {\n      if (match[1]) {\n        domains.add(match[1].toLowerCase());\n      }\n    }\n  });\n  return Array.from(domains);\n}\n\nfunction resolveEvaluateUrl(options: FormBlockerInitOptions): string {\n  const baseUrl =\n    (options.apiBaseUrl && options.apiBaseUrl.trim()) ||\n    (typeof window !== 'undefined' ? window.location.origin : '');\n  const trimmedBase = baseUrl.replace(/\\/+$/, '');\n  const evaluatePath = (options.evaluatePath || '/api/v1/evaluate').trim() || '/api/v1/evaluate';\n  if (/^https?:\\/\\//i.test(evaluatePath)) {\n    return evaluatePath;\n  }\n  return `${trimmedBase}${evaluatePath.startsWith('/') ? evaluatePath : `/${evaluatePath}`}`;\n}\n\nfunction createOverlay(): HTMLDivElement {\n  const overlay = document.createElement('div');\n  overlay.className = 'fb-loading';\n  overlay.style.cssText = [\n    'position:absolute',\n    'top:0',\n    'left:0',\n    'right:0',\n    'bottom:0',\n    'background:rgba(255,255,255,0.8)',\n    'display:flex',\n    'align-items:center',\n    'justify-content:center',\n    'z-index:1000',\n  ].join(';');\n\n  const spinner = document.createElement('div');\n  spinner.style.cssText = [\n    'border:4px solid #f3f4f6',\n    'border-top:4px solid #3b82f6',\n    'border-radius:50%',\n    'width:40px',\n    'height:40px',\n    'animation:fb-spin 1s linear infinite',\n  ].join(';');\n\n  overlay.appendChild(spinner);\n\n  if (!document.getElementById('fb-styles')) {\n    const style = document.createElement('style');\n    style.id = 'fb-styles';\n    style.textContent =\n      '@keyframes fb-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';\n    document.head.appendChild(style);\n  }\n\n  return overlay;\n}\n\ntype ModalTone = 'info' | 'warning' | 'error';\n\ninterface ModalOptions {\n  title: string;\n  message: string;\n  type: ModalTone;\n  subtitle?: string;\n  note?: string;\n  reasons?: string[];\n  submissionId?: string;\n  primaryActionLabel?: string;\n  primaryAction?: () => void;\n}\n\nlet modalStylesInjected = false;\n\nfunction ensureModalStyles(): void {\n  if (modalStylesInjected || typeof document === 'undefined') {\n    return;\n  }\n\n  const style = document.createElement('style');\n  style.id = 'fb-modal-styles';\n  style.textContent = `\n.fb-modal-overlay {\n  position: fixed;\n  inset: 0;\n  background: rgba(15, 23, 42, 0.75);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 24px;\n  z-index: 10000;\n  backdrop-filter: blur(2px);\n  transition: opacity 0.2s ease, transform 0.2s ease;\n}\n.fb-modal-overlay.fb-modal-hide {\n  opacity: 0;\n  transform: translateY(8px);\n}\n.fb-modal-window {\n  width: min(480px, calc(100% - 32px));\n  background: #ffffff;\n  color: #0f172a;\n  border-radius: 16px;\n  padding: 28px 28px 24px;\n  position: relative;\n  box-shadow: 0 35px 65px rgba(15, 23, 42, 0.35);\n  font-family: 'Inter', 'Noto Sans JP', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n}\n.fb-modal-hero {\n  width: 60px;\n  height: 60px;\n  border-radius: 18px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 1.8rem;\n  font-weight: 700;\n  margin-bottom: 18px;\n}\n.fb-modal-hero.fb-error {\n  background: rgba(239, 68, 68, 0.15);\n  color: #b91c1c;\n}\n.fb-modal-hero.fb-warning {\n  background: rgba(245, 158, 11, 0.15);\n  color: #92400e;\n}\n.fb-modal-hero.fb-info {\n  background: rgba(14, 165, 233, 0.15);\n  color: #0369a1;\n}\n.fb-modal-window.fb-error {\n  border-top: 4px solid #ef4444;\n}\n.fb-modal-window.fb-warning {\n  border-top: 4px solid #f59e0b;\n}\n.fb-modal-window.fb-info {\n  border-top: 4px solid #0ea5e9;\n}\n.fb-modal-close {\n  position: absolute;\n  top: 12px;\n  right: 12px;\n  border: none;\n  background: transparent;\n  font-size: 1.4rem;\n  color: #94a3b8;\n  cursor: pointer;\n}\n.fb-modal-title {\n  margin: 0 0 12px;\n  font-size: 1.4rem;\n  font-weight: 700;\n}\n.fb-modal-subtitle {\n  margin: 0 0 12px;\n  font-size: 0.95rem;\n  color: #475569;\n  line-height: 1.5;\n}\n.fb-modal-message {\n  margin: 0;\n  line-height: 1.6;\n  color: #1f2937;\n}\n.fb-modal-note {\n  margin-top: 18px;\n  font-size: 0.9rem;\n  color: #475569;\n  background: rgba(148, 163, 184, 0.15);\n  border-radius: 12px;\n  padding: 12px 14px;\n}\n.fb-reason-list {\n  margin: 16px 0 0;\n  padding-left: 20px;\n  color: #475569;\n}\n.fb-reason-list li {\n  margin-bottom: 4px;\n}\n.fb-submission-id {\n  margin-top: 18px;\n  font-size: 0.9rem;\n  color: #64748b;\n  word-break: break-all;\n}\n.fb-modal-actions {\n  margin-top: 24px;\n  display: flex;\n  justify-content: flex-end;\n  gap: 12px;\n}\n.fb-modal-btn {\n  border: none;\n  border-radius: 999px;\n  padding: 10px 18px;\n  font-size: 0.95rem;\n  font-weight: 600;\n  cursor: pointer;\n}\n.fb-modal-btn.fb-secondary {\n  background: #e2e8f0;\n  color: #0f172a;\n}\n.fb-modal-btn.fb-primary {\n  background: #111827;\n  color: #ffffff;\n}\n@media (prefers-color-scheme: dark) {\n  .fb-modal-window {\n    background: #0f172a;\n    color: #e2e8f0;\n    box-shadow: 0 35px 65px rgba(0, 0, 0, 0.65);\n  }\n  .fb-modal-message {\n    color: #e2e8f0;\n  }\n  .fb-reason-list {\n    color: #cbd5f5;\n  }\n  .fb-submission-id {\n    color: #94a3b8;\n  }\n  .fb-modal-btn.fb-secondary {\n    background: #1e293b;\n    color: #e2e8f0;\n  }\n  .fb-modal-btn.fb-primary {\n    background: #22d3ee;\n    color: #0f172a;\n  }\n  .fb-modal-subtitle,\n  .fb-modal-note {\n    color: #cbd5f5;\n    background: rgba(51, 65, 85, 0.6);\n  }\n}\n`;\n\n  document.head.appendChild(style);\n  modalStylesInjected = true;\n}\n\nfunction getHeroSymbol(type: ModalTone): string {\n  switch (type) {\n    case 'error':\n      return '!';\n    case 'warning':\n      return '?';\n    default:\n      return 'ℹ︎';\n  }\n}\n\nfunction showDecisionModal(options: ModalOptions): void {\n  if (typeof document === 'undefined') {\n    return;\n  }\n\n  ensureModalStyles();\n\n  const overlay = document.createElement('div');\n  overlay.className = 'fb-modal-overlay';\n\n  const modal = document.createElement('div');\n  modal.className = `fb-modal-window fb-${options.type}`;\n  modal.setAttribute('role', 'dialog');\n  modal.setAttribute('aria-modal', 'true');\n  modal.setAttribute('aria-label', options.title);\n\n  const hero = document.createElement('div');\n  hero.className = `fb-modal-hero fb-${options.type}`;\n  hero.setAttribute('aria-hidden', 'true');\n  hero.textContent = getHeroSymbol(options.type);\n\n  const closeModal = () => {\n    overlay.classList.add('fb-modal-hide');\n    window.setTimeout(() => {\n      if (overlay.parentElement) {\n        overlay.parentElement.removeChild(overlay);\n      }\n    }, 180);\n  };\n\n  const closeButton = document.createElement('button');\n  closeButton.className = 'fb-modal-close';\n  closeButton.type = 'button';\n  closeButton.setAttribute('aria-label', '閉じる');\n  closeButton.innerHTML = '&times;';\n  closeButton.addEventListener('click', closeModal);\n\n  const title = document.createElement('h2');\n  title.className = 'fb-modal-title';\n  title.textContent = options.title;\n\n  const subtitle = options.subtitle\n    ? (() => {\n        const element = document.createElement('p');\n        element.className = 'fb-modal-subtitle';\n        element.textContent = options.subtitle;\n        return element;\n      })()\n    : null;\n\n  const message = document.createElement('p');\n  message.className = 'fb-modal-message';\n  message.textContent = options.message;\n\n  modal.appendChild(closeButton);\n  modal.appendChild(hero);\n  modal.appendChild(title);\n  if (subtitle) {\n    modal.appendChild(subtitle);\n  }\n  modal.appendChild(message);\n\n  if (options.reasons && options.reasons.length > 0) {\n    const list = document.createElement('ul');\n    list.className = 'fb-reason-list';\n    options.reasons.forEach((reason) => {\n      const item = document.createElement('li');\n      item.textContent = reason;\n      list.appendChild(item);\n    });\n    modal.appendChild(list);\n  }\n\n  if (options.note) {\n    const note = document.createElement('p');\n    note.className = 'fb-modal-note';\n    note.textContent = options.note;\n    modal.appendChild(note);\n  }\n\n  if (options.submissionId) {\n    const submission = document.createElement('p');\n    submission.className = 'fb-submission-id';\n    submission.textContent = `受付ID: ${options.submissionId}`;\n    modal.appendChild(submission);\n  }\n\n  const actions = document.createElement('div');\n  actions.className = 'fb-modal-actions';\n\n  if (options.primaryAction && options.primaryActionLabel) {\n    const primaryButton = document.createElement('button');\n    primaryButton.className = 'fb-modal-btn fb-primary';\n    primaryButton.type = 'button';\n    primaryButton.textContent = options.primaryActionLabel;\n    primaryButton.addEventListener('click', () => {\n      options.primaryAction?.();\n      closeModal();\n    });\n    actions.appendChild(primaryButton);\n  }\n\n  const dismissButton = document.createElement('button');\n  dismissButton.className = 'fb-modal-btn fb-secondary';\n  dismissButton.type = 'button';\n  dismissButton.textContent = '閉じる';\n  dismissButton.addEventListener('click', closeModal);\n  actions.appendChild(dismissButton);\n\n  modal.appendChild(actions);\n  overlay.appendChild(modal);\n\n  overlay.addEventListener('click', (event) => {\n    if (event.target === overlay) {\n      closeModal();\n    }\n  });\n\n  document.body.appendChild(overlay);\n}\n\nfunction showBlockModal(result: EvaluateSuccessResponse): void {\n  const message =\n    result.message || '営業目的または不正な送信と判定されたため、送信をブロックしました。';\n\n  showDecisionModal({\n    title: '送信がブロックされました',\n    subtitle: '申し訳ありませんが、この送信内容は営業目的またはスパムの可能性が高いため送信できませんでした。',\n    message,\n    type: 'error',\n    reasons: result.reasons,\n    submissionId: result.submission_id,\n    note:\n      '心当たりがない場合は、入力内容を見直すか別の連絡手段でお問い合わせください。再送時は URL や営業キーワードが含まれていないかをご確認ください。',\n  });\n}\n\nfunction showBanner(message: string, type: 'info' | 'error'): void {\n  const div = document.createElement('div');\n  div.className = `fb-message fb-${type}`;\n  div.textContent = message;\n  div.style.cssText = [\n    'position:fixed',\n    'top:20px',\n    'left:50%',\n    'transform:translateX(-50%)',\n    'padding:16px 24px',\n    'border-radius:8px',\n    `background:${type === 'error' ? '#ef4444' : '#3b82f6'}`,\n    'color:white',\n    'box-shadow:0 4px 6px rgba(0,0,0,0.1)',\n    'z-index:10000',\n    'font-family:sans-serif',\n  ].join(';');\n\n  document.body.appendChild(div);\n\n  setTimeout(() => {\n    div.style.transition = 'opacity 0.3s';\n    div.style.opacity = '0';\n    setTimeout(() => {\n      if (div.parentElement) {\n        div.parentElement.removeChild(div);\n      }\n    }, 300);\n  }, 3000);\n}\n\nclass FormBlockerCore {\n  private config: InternalConfig | null = null;\n  private contexts = new Map<HTMLFormElement, FormContext>();\n\n  init(options: FormBlockerInitOptions): void {\n    if (typeof window === 'undefined' || typeof document === 'undefined') {\n      return;\n    }\n\n    if (!options || !options.apiKey) {\n      console.error('[FormBlocker] apiKey is required');\n      return;\n    }\n\n    this.destroy();\n\n    const normalizeKeywords = (keywords: string[]) => keywords.map((kw) => kw.toLowerCase());\n\n    this.config = {\n      apiKey: options.apiKey,\n      evaluateUrl: resolveEvaluateUrl(options),\n      selector: options.selector || 'form',\n      debug: Boolean(options.debug),\n      previewMode: Boolean(options.previewMode),\n      salesKeywords: options.debugRules?.salesKeywords?.length\n        ? normalizeKeywords(options.debugRules.salesKeywords)\n        : normalizeKeywords(DEFAULT_SALES_KEYWORDS),\n      bannedKeywords: options.debugRules?.bannedKeywords?.length\n        ? normalizeKeywords(options.debugRules.bannedKeywords)\n        : normalizeKeywords(DEFAULT_BANNED_KEYWORDS),\n      blockedDomains: options.debugRules?.blockedDomains?.length\n        ? options.debugRules.blockedDomains.map(normalizeDomain)\n        : [],\n      onAllow: options.onAllow,\n      onBlock: options.onBlock,\n      onChallenge: options.onChallenge,\n      onHold: options.onHold,\n      onError: options.onError,\n      onDetectionUpdate: options.onDetectionUpdate,\n    };\n\n    this.log('Initialized with config', this.config);\n    this.attachToForms();\n  }\n\n  refresh(): void {\n    if (!this.config) {\n      this.log('Refresh skipped: config not initialized');\n      return;\n    }\n    this.attachToForms();\n  }\n\n  destroy(): void {\n    this.contexts.forEach((context, form) => {\n      form.removeAttribute('data-fb-attached');\n      form.removeEventListener('submit', context.submitHandler, true);\n      context.pasteHandlers.forEach(({ element, handler }) => {\n        element.removeEventListener('paste', handler);\n      });\n      context.inputHandlers.forEach(({ element, handler }) => {\n        element.removeEventListener('input', handler);\n      });\n    });\n    this.contexts.clear();\n  }\n\n  private attachToForms(): void {\n    if (!this.config) {\n      return;\n    }\n\n    const forms = document.querySelectorAll<HTMLFormElement>(this.config.selector);\n    forms.forEach((form) => {\n      if (this.contexts.has(form)) {\n        return;\n      }\n      this.attachToForm(form);\n    });\n  }\n\n  private attachToForm(form: HTMLFormElement): void {\n    if (!this.config) {\n      return;\n    }\n\n    const behavioral: BehavioralSnapshot = {\n      pasteDetected: false,\n      timeToSubmit: null,\n      pageLoadTime: Date.now(),\n    };\n\n    const submitHandler = (event: Event) => {\n      this.handleSubmit(event as SubmitEvent, form, behavioral).catch((error) => {\n        this.log('Submission handling failed', error);\n      });\n    };\n\n    const pasteHandlers: Array<{ element: Element; handler: EventListener }> = [];\n    const inputHandlers: Array<{ element: Element; handler: EventListener }> = [];\n    const inputElements = form.querySelectorAll('input, textarea');\n    inputElements.forEach((element) => {\n      const handler = () => {\n        behavioral.pasteDetected = true;\n        this.log('Paste detected for form', form);\n        this.emitDetectionUpdate(form, behavioral);\n      };\n      element.addEventListener('paste', handler);\n      pasteHandlers.push({ element, handler });\n    });\n\n    inputElements.forEach((element) => {\n      const handler = () => {\n        this.emitDetectionUpdate(form, behavioral);\n      };\n      element.addEventListener('input', handler);\n      inputHandlers.push({ element, handler });\n    });\n\n    form.addEventListener('submit', submitHandler, true);\n    form.setAttribute('data-fb-attached', 'true');\n\n    this.emitDetectionUpdate(form, behavioral);\n\n    this.contexts.set(form, {\n      originalSubmit: form.onsubmit,\n      submitHandler,\n      pasteHandlers,\n      inputHandlers,\n      behavioral,\n    });\n\n    this.log('Attached to form', form);\n  }\n\n  private async handleSubmit(\n    event: SubmitEvent,\n    form: HTMLFormElement,\n    behavioral: BehavioralSnapshot\n  ): Promise<void> {\n    if (!this.config) {\n      return;\n    }\n\n    event.preventDefault();\n    event.stopPropagation();\n\n    behavioral.timeToSubmit = (Date.now() - behavioral.pageLoadTime) / 1000;\n\n    this.showLoading(form);\n\n    this.emitDetectionUpdate(form, behavioral);\n\n    try {\n      const payload = this.buildRequestBody(form, behavioral);\n      this.log('Submitting payload', payload);\n\n      const response = await fetch(this.config.evaluateUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        throw new Error(`API request failed with status ${response.status}`);\n      }\n\n      const result = (await response.json()) as EvaluateResponsePayload;\n      this.log('Received response', result);\n\n      if (!result.success) {\n        const message = result.error?.message || 'エラーが発生しました。後ほど再度お試しください。';\n        showBanner(message, 'error');\n        this.config.onError?.(result);\n        this.hideLoading(form);\n        return;\n      }\n\n      this.handleDecision(result, form);\n    } catch (error) {\n      console.error('[FormBlocker] API error', error);\n      this.config.onError?.(error);\n      this.hideLoading(form);\n      this.allowSubmission(form);\n    }\n  }\n\n  private buildRequestBody(form: HTMLFormElement, behavioral: BehavioralSnapshot) {\n    const metadata = {\n      url: typeof window !== 'undefined' ? window.location.href : '',\n      user_agent: typeof navigator !== 'undefined' ? navigator.userAgent : '',\n      timestamp: Date.now(),\n    };\n\n    const behavioralData: Record<string, unknown> = {\n      paste_detected: behavioral.pasteDetected,\n    };\n\n    if (typeof behavioral.timeToSubmit === 'number' && !Number.isNaN(behavioral.timeToSubmit)) {\n      behavioralData.time_to_submit = behavioral.timeToSubmit;\n    }\n\n    return {\n      api_key: this.config?.apiKey,\n      form_data: this.extractFormData(form),\n      metadata,\n      behavioral_data: behavioralData,\n    };\n  }\n\n  private extractFormData(form: HTMLFormElement): Record<string, unknown> {\n    const data: Record<string, unknown> = {};\n    const elements = Array.from(form.elements) as Array<HTMLInputElement | HTMLTextAreaElement>;\n\n    elements.forEach((element) => {\n      if (!element.name) {\n        return;\n      }\n\n      const type = (element as HTMLInputElement).type;\n      if (type === 'checkbox') {\n        const input = element as HTMLInputElement;\n        if (!data[element.name]) {\n          data[element.name] = [];\n        }\n        if (input.checked) {\n          (data[element.name] as unknown[]).push(input.value);\n        }\n        return;\n      }\n\n      if (type === 'radio') {\n        const input = element as HTMLInputElement;\n        if (input.checked) {\n          data[element.name] = input.value;\n        } else if (!(element.name in data)) {\n          data[element.name] = null;\n        }\n        return;\n      }\n\n      data[element.name] = element.value;\n    });\n\n    return data;\n  }\n\n  private handleDecision(result: EvaluateSuccessResponse, form: HTMLFormElement): void {\n    switch (result.decision) {\n      case 'allowed':\n        this.allowSubmission(form);\n        this.hideLoading(form);\n        this.config?.onAllow?.(result);\n        break;\n      case 'challenged':\n        this.hideLoading(form);\n        this.handleChallenge(result, form);\n        break;\n      case 'held':\n        this.hideLoading(form);\n        showBanner(result.message, 'info');\n        this.config?.onHold?.(result);\n        break;\n      case 'blocked':\n        this.hideLoading(form);\n        showBlockModal(result);\n        this.config?.onBlock?.(result);\n        break;\n      default:\n        this.hideLoading(form);\n        this.allowSubmission(form);\n    }\n  }\n\n  private handleChallenge(result: EvaluateSuccessResponse, form: HTMLFormElement): void {\n    const allow = () => {\n      this.allowSubmission(form);\n      this.config?.onAllow?.(result);\n    };\n\n    if (this.config?.onChallenge) {\n      this.config.onChallenge(result, allow);\n      return;\n    }\n\n    const question =\n      result.challenge?.question || 'この送信は営業目的ではありませんか？送信を続けますか？';\n    const confirmed = window.confirm(`${question}\\n\\n「OK」を押すと送信されます。`);\n    if (confirmed) {\n      allow();\n    }\n  }\n\n  private allowSubmission(form: HTMLFormElement): void {\n    if (this.config?.previewMode) {\n      return;\n    }\n    const context = this.contexts.get(form);\n    if (context?.originalSubmit) {\n      const event = new Event('submit', { bubbles: true, cancelable: true });\n      context.originalSubmit.call(form, event as SubmitEvent);\n    } else {\n      form.submit();\n    }\n  }\n\n  private showLoading(form: HTMLFormElement): void {\n    if (!form.querySelector('.fb-loading')) {\n      const overlay = createOverlay();\n      const style = window.getComputedStyle(form);\n      if (style.position === 'static' || !style.position) {\n        form.style.position = 'relative';\n      }\n      form.appendChild(overlay);\n    }\n  }\n\n  private hideLoading(form: HTMLFormElement): void {\n    const overlay = form.querySelector('.fb-loading');\n    if (overlay && overlay.parentElement) {\n      overlay.parentElement.removeChild(overlay);\n    }\n  }\n\n  private log(message: string, payload?: unknown): void {\n    if (!this.config?.debug) return;\n    if (payload !== undefined) {\n      console.log(`[FormBlocker ${FORM_BLOCKER_VERSION}] ${message}`, payload);\n    } else {\n      console.log(`[FormBlocker ${FORM_BLOCKER_VERSION}] ${message}`);\n    }\n  }\n\n  private emitDetectionUpdate(form: HTMLFormElement, behavioral: BehavioralSnapshot): void {\n    if (!this.config?.onDetectionUpdate) {\n      return;\n    }\n\n    const context = this.contexts.get(form);\n    const formData = this.extractFormData(form);\n    const snapshot = this.analyzeDetection(formData, behavioral);\n\n    context && (context.lastDetection = snapshot);\n\n    this.config.onDetectionUpdate(snapshot);\n  }\n\n  private analyzeDetection(formData: Record<string, unknown>, behavioral: BehavioralSnapshot): DetectionSnapshot {\n    const textFragments = Object.values(formData).map((value) => {\n      if (typeof value === 'string') return value;\n      if (Array.isArray(value)) return value.join(' ');\n      return '';\n    });\n\n    const values = textFragments.join(' ').toLowerCase();\n\n    const urlRegex = /(https?:\\/\\/[^\\s]+)/gi;\n    const detectedUrls = values.match(urlRegex) || [];\n    const schedulingUrls = detectedUrls.filter((url) => {\n      const domain = extractHostname(url);\n      if (!domain) return false;\n      return DEFAULT_SCHEDULING_DOMAINS.some((target) => matchesDomain(domain, target));\n    });\n\n    const salesKeywords = this.config?.salesKeywords || DEFAULT_SALES_KEYWORDS;\n    const bannedKeywords = this.config?.bannedKeywords || DEFAULT_BANNED_KEYWORDS;\n\n    const detectedSales = salesKeywords.filter((kw) => kw && values.includes(kw.toLowerCase()));\n    const detectedBanned = bannedKeywords.filter((kw) => kw && values.includes(kw.toLowerCase()));\n\n    const emailDomains = collectEmailDomains(formData);\n    const blockedDomainMatches: string[] = [];\n    const configuredBlockedDomains = this.config?.blockedDomains || [];\n\n    if (configuredBlockedDomains.length > 0) {\n      const urlDomains = Array.from(\n        new Set(\n          detectedUrls\n            .map((url) => extractHostname(url))\n            .filter((domain): domain is string => Boolean(domain))\n        )\n      );\n      const candidates = Array.from(new Set([...urlDomains, ...emailDomains])).map(normalizeDomain);\n      candidates.forEach((domain) => {\n        if (configuredBlockedDomains.some((blocked) => matchesDomain(domain, blocked))) {\n          blockedDomainMatches.push(domain);\n        }\n      });\n    }\n\n    return {\n      urlDetected: detectedUrls.length > 0,\n      detectedUrls,\n      schedulingUrls,\n      salesKeywords: detectedSales,\n      bannedKeywords: detectedBanned,\n      blockedDomains: blockedDomainMatches,\n      pasteDetected: behavioral.pasteDetected,\n      contentLength: values.length,\n      updatedAt: Date.now(),\n    };\n  }\n}\n\nconst core = new FormBlockerCore();\n\nconst FormBlocker = {\n  init(options: FormBlockerInitOptions): void {\n    core.init(options);\n  },\n  refresh(): void {\n    core.refresh();\n  },\n  destroy(): void {\n    core.destroy();\n  },\n};\n\ndeclare global {\n  interface Window {\n    FormBlocker?: typeof FormBlocker;\n    FormBlockerAutoInit?: FormBlockerInitOptions;\n  }\n}\n\nif (typeof window !== 'undefined') {\n  window.FormBlocker = FormBlocker;\n  (window as typeof window & { FormBlockerVersion?: string }).FormBlockerVersion = FORM_BLOCKER_VERSION;\n\n  const autoInit = window.FormBlockerAutoInit;\n  if (autoInit) {\n    FormBlocker.init(autoInit);\n  }\n\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n      const pendingConfig = window.FormBlockerAutoInit;\n      if (pendingConfig) {\n        FormBlocker.init(pendingConfig);\n      }\n    });\n  }\n}\n\nexport default FormBlocker;\n"],"names":["FORM_BLOCKER_VERSION","DEFAULT_SALES_KEYWORDS","DEFAULT_BANNED_KEYWORDS","DEFAULT_SCHEDULING_DOMAINS","normalizeDomain","domain","matchesDomain","target","extractHostname","url","_a","match","collectEmailDomains","formData","domains","regex","value","matches","resolveEvaluateUrl","options","trimmedBase","evaluatePath","createOverlay","overlay","spinner","style","modalStylesInjected","ensureModalStyles","getHeroSymbol","type","showDecisionModal","modal","hero","closeModal","closeButton","title","subtitle","element","message","list","reason","item","note","submission","actions","primaryButton","dismissButton","event","showBlockModal","result","showBanner","div","FormBlockerCore","_b","_c","_d","_e","_f","normalizeKeywords","keywords","kw","context","form","handler","behavioral","submitHandler","error","pasteHandlers","inputHandlers","inputElements","payload","response","metadata","behavioralData","data","input","allow","question","snapshot","values","urlRegex","detectedUrls","schedulingUrls","salesKeywords","bannedKeywords","detectedSales","detectedBanned","emailDomains","blockedDomainMatches","configuredBlockedDomains","urlDomains","blocked","core","FormBlocker","autoInit","pendingConfig"],"mappings":"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"}