{"version":3,"file":"form-blocker.mjs","sources":["../../embed-script/src/index.ts"],"sourcesContent":["type SubmissionDecision = 'allowed' | 'challenged' | 'held' | 'blocked';\n\ninterface ChallengePayload {\n  type?: string;\n  question?: string;\n}\n\ninterface EvaluateSuccessResponse {\n  success: true;\n  decision: SubmissionDecision;\n  message: string;\n  submission_id?: string;\n  scores?: {\n    sales: number;\n    spam: number;\n  };\n  reasons?: string[];\n  challenge?: ChallengePayload;\n}\n\ninterface EvaluateErrorResponse {\n  success: false;\n  error: {\n    code?: string;\n    message?: string;\n  };\n}\n\ntype EvaluateResponsePayload = EvaluateSuccessResponse | EvaluateErrorResponse;\n\ninterface DetectionSnapshot {\n  urlDetected: boolean;\n  detectedUrls: string[];\n  schedulingUrls: string[];\n  salesKeywords: string[];\n  bannedKeywords: string[];\n  blockedDomains: string[];\n  pasteDetected: boolean;\n  contentLength: number;\n  updatedAt: number;\n}\n\nexport interface FormBlockerInitOptions {\n  apiKey: string;\n  apiBaseUrl?: string;\n  evaluatePath?: string;\n  selector?: string;\n  debug?: boolean;\n  previewMode?: boolean;\n  debugRules?: {\n    salesKeywords?: string[];\n    bannedKeywords?: string[];\n    blockedDomains?: string[];\n  };\n  observeMutations?: boolean;\n  discoveryIntervalMs?: number;\n  discoveryTimeoutMs?: number;\n  onAllow?: (result: EvaluateSuccessResponse) => void;\n  onBlock?: (result: EvaluateSuccessResponse) => void;\n  onChallenge?: (result: EvaluateSuccessResponse, allow: () => void) => void;\n  onHold?: (result: EvaluateSuccessResponse) => void;\n  onError?: (error: unknown) => void;\n  onDetectionUpdate?: (snapshot: DetectionSnapshot) => void;\n}\n\ninterface InternalConfig {\n  apiKey: string;\n  evaluateUrl: string;\n  selector: string;\n  debug: boolean;\n  previewMode: boolean;\n  salesKeywords: string[];\n  bannedKeywords: string[];\n  blockedDomains: string[];\n  observeMutations: boolean;\n  discoveryIntervalMs: number;\n  discoveryTimeoutMs: number | null;\n  onAllow?: FormBlockerInitOptions['onAllow'];\n  onBlock?: FormBlockerInitOptions['onBlock'];\n  onChallenge?: FormBlockerInitOptions['onChallenge'];\n  onHold?: FormBlockerInitOptions['onHold'];\n  onError?: FormBlockerInitOptions['onError'];\n  onDetectionUpdate?: FormBlockerInitOptions['onDetectionUpdate'];\n}\n\ninterface BehavioralSnapshot {\n  pasteDetected: boolean;\n  timeToSubmit: number | null;\n  pageLoadTime: number;\n}\n\ninterface FormContext {\n  originalSubmit: ((this: HTMLFormElement, ev: SubmitEvent) => unknown) | null;\n  submitHandler: EventListener;\n  pasteHandlers: Array<{ element: Element; handler: EventListener }>;\n  inputHandlers: Array<{ element: Element; handler: EventListener }>;\n  behavioral: BehavioralSnapshot;\n  lastDetection?: DetectionSnapshot;\n}\n\nconst FORM_BLOCKER_VERSION = '2024-12-05-fixed-base';\nconst DEFAULT_API_BASE = 'https://form-blocker.vercel.app';\n\nconst DEFAULT_SALES_KEYWORDS = ['営業', 'セールス', '提案', '御社', '貴社', '販売', '広告', '代理店'];\nconst DEFAULT_BANNED_KEYWORDS = ['無料', '限定', '販売促進', '広告代理店'];\nconst DEFAULT_SCHEDULING_DOMAINS = [\n  'calendly.com',\n  'youcanbook.me',\n  'scheduleonce.com',\n  'acuityscheduling.com',\n  'savvycal.com',\n  'hubspot.com',\n  'meetings.hubspot.com',\n  'tidycal.com',\n  'cal.com',\n];\n\nfunction normalizeDomain(domain: string): string {\n  return domain.trim().toLowerCase();\n}\n\nfunction matchesDomain(domain: string, target: string): boolean {\n  return domain === target || domain.endsWith(`.${target}`);\n}\n\nfunction extractHostname(url: string): string | null {\n  try {\n    return new URL(url).hostname.toLowerCase();\n  } catch {\n    const match = url.match(/https?:\\/\\/([^/\\s]+)/i);\n    return match?.[1]?.toLowerCase() ?? null;\n  }\n}\n\nfunction collectEmailDomains(formData: Record<string, unknown>): string[] {\n  const domains = new Set<string>();\n  const regex = /[\\w.+-]+@([A-Za-z0-9.-]+\\.[A-Za-z]{2,})/g;\n  Object.values(formData).forEach((value) => {\n    if (typeof value !== 'string') {\n      return;\n    }\n    const matches = value.matchAll(regex);\n    for (const match of matches) {\n      if (match[1]) {\n        domains.add(match[1].toLowerCase());\n      }\n    }\n  });\n  return Array.from(domains);\n}\n\nfunction getScriptOrigin(): string | null {\n  if (typeof document === 'undefined') {\n    return null;\n  }\n\n  const currentScript = document.currentScript as HTMLScriptElement | null;\n  const scripts = Array.from(document.querySelectorAll<HTMLScriptElement>('script'));\n  const scriptEl =\n    currentScript ||\n    scripts.find((script) => /form-blocker(\\.min)?\\.(js|mjs)$/.test(script.src) || script.dataset.apiBaseUrl);\n\n  const explicitBase = scriptEl?.dataset.apiBaseUrl?.trim();\n  const scriptSrc = scriptEl?.src;\n\n  try {\n    if (explicitBase) {\n      return new URL(explicitBase).origin;\n    }\n    if (scriptSrc) {\n      return new URL(scriptSrc).origin;\n    }\n  } catch {\n    // ignore parse errors\n  }\n\n  return null;\n}\n\nfunction resolveEvaluateUrl(options: FormBlockerInitOptions): string {\n  const optionBase = options.apiBaseUrl?.trim();\n  const baseUrl = optionBase && optionBase.length ? optionBase : DEFAULT_API_BASE;\n  const trimmedBase = baseUrl.replace(/\\/+$/, '');\n  const evaluatePath = (options.evaluatePath || '/api/v1/evaluate').trim() || '/api/v1/evaluate';\n  if (/^https?:\\/\\//i.test(evaluatePath)) {\n    return evaluatePath;\n  }\n  return `${trimmedBase}${evaluatePath.startsWith('/') ? evaluatePath : `/${evaluatePath}`}`;\n}\n\nfunction createOverlay(): HTMLDivElement {\n  const overlay = document.createElement('div');\n  overlay.className = 'fb-loading';\n  overlay.style.cssText = [\n    'position:absolute',\n    'top:0',\n    'left:0',\n    'right:0',\n    'bottom:0',\n    'background:rgba(255,255,255,0.8)',\n    'display:flex',\n    'align-items:center',\n    'justify-content:center',\n    'z-index:1000',\n  ].join(';');\n\n  const spinner = document.createElement('div');\n  spinner.style.cssText = [\n    'border:4px solid #f3f4f6',\n    'border-top:4px solid #3b82f6',\n    'border-radius:50%',\n    'width:40px',\n    'height:40px',\n    'animation:fb-spin 1s linear infinite',\n  ].join(';');\n\n  overlay.appendChild(spinner);\n\n  if (!document.getElementById('fb-styles')) {\n    const style = document.createElement('style');\n    style.id = 'fb-styles';\n    style.textContent =\n      '@keyframes fb-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';\n    document.head.appendChild(style);\n  }\n\n  return overlay;\n}\n\ntype ModalTone = 'info' | 'warning' | 'error';\n\ninterface ModalOptions {\n  title: string;\n  message: string;\n  type: ModalTone;\n  subtitle?: string;\n  note?: string;\n  reasons?: string[];\n  submissionId?: string;\n  primaryActionLabel?: string;\n  primaryAction?: () => void;\n}\n\nlet modalStylesInjected = false;\n\nfunction ensureModalStyles(): void {\n  if (modalStylesInjected || typeof document === 'undefined') {\n    return;\n  }\n\n  const style = document.createElement('style');\n  style.id = 'fb-modal-styles';\n  style.textContent = `\n.fb-modal-overlay {\n  position: fixed;\n  inset: 0;\n  background: rgba(15, 23, 42, 0.75);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 24px;\n  z-index: 10000;\n  backdrop-filter: blur(2px);\n  transition: opacity 0.2s ease, transform 0.2s ease;\n}\n.fb-modal-overlay.fb-modal-hide {\n  opacity: 0;\n  transform: translateY(8px);\n}\n.fb-modal-window {\n  width: min(480px, calc(100% - 32px));\n  background: #ffffff;\n  color: #0f172a;\n  border-radius: 16px;\n  padding: 28px 28px 24px;\n  position: relative;\n  box-shadow: 0 35px 65px rgba(15, 23, 42, 0.35);\n  font-family: 'Inter', 'Noto Sans JP', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n}\n.fb-modal-hero {\n  width: 60px;\n  height: 60px;\n  border-radius: 18px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 1.8rem;\n  font-weight: 700;\n  margin-bottom: 18px;\n}\n.fb-modal-hero.fb-error {\n  background: rgba(239, 68, 68, 0.15);\n  color: #b91c1c;\n}\n.fb-modal-hero.fb-warning {\n  background: rgba(245, 158, 11, 0.15);\n  color: #92400e;\n}\n.fb-modal-hero.fb-info {\n  background: rgba(14, 165, 233, 0.15);\n  color: #0369a1;\n}\n.fb-modal-window.fb-error {\n  border-top: 4px solid #ef4444;\n}\n.fb-modal-window.fb-warning {\n  border-top: 4px solid #f59e0b;\n}\n.fb-modal-window.fb-info {\n  border-top: 4px solid #0ea5e9;\n}\n.fb-modal-close {\n  position: absolute;\n  top: 12px;\n  right: 12px;\n  border: none;\n  background: transparent;\n  font-size: 1.4rem;\n  color: #94a3b8;\n  cursor: pointer;\n}\n.fb-modal-title {\n  margin: 0 0 12px;\n  font-size: 1.4rem;\n  font-weight: 700;\n}\n.fb-modal-subtitle {\n  margin: 0 0 12px;\n  font-size: 0.95rem;\n  color: #475569;\n  line-height: 1.5;\n}\n.fb-modal-message {\n  margin: 0;\n  line-height: 1.6;\n  color: #1f2937;\n}\n.fb-modal-note {\n  margin-top: 18px;\n  font-size: 0.9rem;\n  color: #475569;\n  background: rgba(148, 163, 184, 0.15);\n  border-radius: 12px;\n  padding: 12px 14px;\n}\n.fb-reason-list {\n  margin: 16px 0 0;\n  padding-left: 20px;\n  color: #475569;\n}\n.fb-reason-list li {\n  margin-bottom: 4px;\n}\n.fb-submission-id {\n  margin-top: 18px;\n  font-size: 0.9rem;\n  color: #64748b;\n  word-break: break-all;\n}\n.fb-modal-actions {\n  margin-top: 24px;\n  display: flex;\n  justify-content: flex-end;\n  gap: 12px;\n}\n.fb-modal-btn {\n  border: none;\n  border-radius: 999px;\n  padding: 10px 18px;\n  font-size: 0.95rem;\n  font-weight: 600;\n  cursor: pointer;\n}\n.fb-modal-btn.fb-secondary {\n  background: #e2e8f0;\n  color: #0f172a;\n}\n.fb-modal-btn.fb-primary {\n  background: #111827;\n  color: #ffffff;\n}\n@media (prefers-color-scheme: dark) {\n  .fb-modal-window {\n    background: #0f172a;\n    color: #e2e8f0;\n    box-shadow: 0 35px 65px rgba(0, 0, 0, 0.65);\n  }\n  .fb-modal-message {\n    color: #e2e8f0;\n  }\n  .fb-reason-list {\n    color: #cbd5f5;\n  }\n  .fb-submission-id {\n    color: #94a3b8;\n  }\n  .fb-modal-btn.fb-secondary {\n    background: #1e293b;\n    color: #e2e8f0;\n  }\n  .fb-modal-btn.fb-primary {\n    background: #22d3ee;\n    color: #0f172a;\n  }\n  .fb-modal-subtitle,\n  .fb-modal-note {\n    color: #cbd5f5;\n    background: rgba(51, 65, 85, 0.6);\n  }\n}\n`;\n\n  document.head.appendChild(style);\n  modalStylesInjected = true;\n}\n\nfunction getHeroSymbol(type: ModalTone): string {\n  switch (type) {\n    case 'error':\n      return '!';\n    case 'warning':\n      return '?';\n    default:\n      return 'ℹ︎';\n  }\n}\n\nfunction showDecisionModal(options: ModalOptions): void {\n  if (typeof document === 'undefined') {\n    return;\n  }\n\n  ensureModalStyles();\n\n  const overlay = document.createElement('div');\n  overlay.className = 'fb-modal-overlay';\n\n  const modal = document.createElement('div');\n  modal.className = `fb-modal-window fb-${options.type}`;\n  modal.setAttribute('role', 'dialog');\n  modal.setAttribute('aria-modal', 'true');\n  modal.setAttribute('aria-label', options.title);\n\n  const hero = document.createElement('div');\n  hero.className = `fb-modal-hero fb-${options.type}`;\n  hero.setAttribute('aria-hidden', 'true');\n  hero.textContent = getHeroSymbol(options.type);\n\n  const closeModal = () => {\n    overlay.classList.add('fb-modal-hide');\n    window.setTimeout(() => {\n      if (overlay.parentElement) {\n        overlay.parentElement.removeChild(overlay);\n      }\n    }, 180);\n  };\n\n  const closeButton = document.createElement('button');\n  closeButton.className = 'fb-modal-close';\n  closeButton.type = 'button';\n  closeButton.setAttribute('aria-label', '閉じる');\n  closeButton.innerHTML = '&times;';\n  closeButton.addEventListener('click', closeModal);\n\n  const title = document.createElement('h2');\n  title.className = 'fb-modal-title';\n  title.textContent = options.title;\n\n  const subtitle = options.subtitle\n    ? (() => {\n        const element = document.createElement('p');\n        element.className = 'fb-modal-subtitle';\n        element.textContent = options.subtitle;\n        return element;\n      })()\n    : null;\n\n  const message = document.createElement('p');\n  message.className = 'fb-modal-message';\n  message.textContent = options.message;\n\n  modal.appendChild(closeButton);\n  modal.appendChild(hero);\n  modal.appendChild(title);\n  if (subtitle) {\n    modal.appendChild(subtitle);\n  }\n  modal.appendChild(message);\n\n  if (options.reasons && options.reasons.length > 0) {\n    const list = document.createElement('ul');\n    list.className = 'fb-reason-list';\n    options.reasons.forEach((reason) => {\n      const item = document.createElement('li');\n      item.textContent = reason;\n      list.appendChild(item);\n    });\n    modal.appendChild(list);\n  }\n\n  if (options.note) {\n    const note = document.createElement('p');\n    note.className = 'fb-modal-note';\n    note.textContent = options.note;\n    modal.appendChild(note);\n  }\n\n  if (options.submissionId) {\n    const submission = document.createElement('p');\n    submission.className = 'fb-submission-id';\n    submission.textContent = `受付ID: ${options.submissionId}`;\n    modal.appendChild(submission);\n  }\n\n  const actions = document.createElement('div');\n  actions.className = 'fb-modal-actions';\n\n  if (options.primaryAction && options.primaryActionLabel) {\n    const primaryButton = document.createElement('button');\n    primaryButton.className = 'fb-modal-btn fb-primary';\n    primaryButton.type = 'button';\n    primaryButton.textContent = options.primaryActionLabel;\n    primaryButton.addEventListener('click', () => {\n      options.primaryAction?.();\n      closeModal();\n    });\n    actions.appendChild(primaryButton);\n  }\n\n  const dismissButton = document.createElement('button');\n  dismissButton.className = 'fb-modal-btn fb-secondary';\n  dismissButton.type = 'button';\n  dismissButton.textContent = '閉じる';\n  dismissButton.addEventListener('click', closeModal);\n  actions.appendChild(dismissButton);\n\n  modal.appendChild(actions);\n  overlay.appendChild(modal);\n\n  overlay.addEventListener('click', (event) => {\n    if (event.target === overlay) {\n      closeModal();\n    }\n  });\n\n  document.body.appendChild(overlay);\n}\n\nfunction showBlockModal(result: EvaluateSuccessResponse): void {\n  const message =\n    result.message || '営業目的または不正な送信と判定されたため、送信をブロックしました。';\n\n  showDecisionModal({\n    title: '送信がブロックされました',\n    subtitle: '申し訳ありませんが、この送信内容は営業目的またはスパムの可能性が高いため送信できませんでした。',\n    message,\n    type: 'error',\n    reasons: result.reasons,\n    submissionId: result.submission_id,\n    note:\n      '心当たりがない場合は、入力内容を見直すか別の連絡手段でお問い合わせください。再送時は URL や営業キーワードが含まれていないかをご確認ください。',\n  });\n}\n\nfunction showBanner(message: string, type: 'info' | 'error'): void {\n  const div = document.createElement('div');\n  div.className = `fb-message fb-${type}`;\n  div.textContent = message;\n  div.style.cssText = [\n    'position:fixed',\n    'top:20px',\n    'left:50%',\n    'transform:translateX(-50%)',\n    'padding:16px 24px',\n    'border-radius:8px',\n    `background:${type === 'error' ? '#ef4444' : '#3b82f6'}`,\n    'color:white',\n    'box-shadow:0 4px 6px rgba(0,0,0,0.1)',\n    'z-index:10000',\n    'font-family:sans-serif',\n  ].join(';');\n\n  document.body.appendChild(div);\n\n  setTimeout(() => {\n    div.style.transition = 'opacity 0.3s';\n    div.style.opacity = '0';\n    setTimeout(() => {\n      if (div.parentElement) {\n        div.parentElement.removeChild(div);\n      }\n    }, 300);\n  }, 3000);\n}\n\nclass FormBlockerCore {\n  private config: InternalConfig | null = null;\n  private contexts = new Map<HTMLFormElement, FormContext>();\n  private mutationObserver: MutationObserver | null = null;\n  private pendingAttachScan = false;\n  private discoveryInterval: number | null = null;\n  private discoveryTimeoutTimer: number | null = null;\n  private lastFoundFormsCount = -1;\n\n  init(options: FormBlockerInitOptions): void {\n    if (typeof window === 'undefined' || typeof document === 'undefined') {\n      return;\n    }\n\n    if (!options || !options.apiKey) {\n      console.error('[FormBlocker] apiKey is required');\n      return;\n    }\n\n    this.destroy();\n\n    const normalizeKeywords = (keywords: string[]) => keywords.map((kw) => kw.toLowerCase());\n\n    this.config = {\n      apiKey: options.apiKey,\n      evaluateUrl: resolveEvaluateUrl(options),\n      selector: options.selector || 'form',\n      debug: Boolean(options.debug),\n      previewMode: Boolean(options.previewMode),\n      salesKeywords: options.debugRules?.salesKeywords?.length\n        ? normalizeKeywords(options.debugRules.salesKeywords)\n        : normalizeKeywords(DEFAULT_SALES_KEYWORDS),\n      bannedKeywords: options.debugRules?.bannedKeywords?.length\n        ? normalizeKeywords(options.debugRules.bannedKeywords)\n        : normalizeKeywords(DEFAULT_BANNED_KEYWORDS),\n      blockedDomains: options.debugRules?.blockedDomains?.length\n        ? options.debugRules.blockedDomains.map(normalizeDomain)\n        : [],\n      observeMutations: options.observeMutations !== false,\n      discoveryIntervalMs:\n        typeof options.discoveryIntervalMs === 'number' && options.discoveryIntervalMs > 0\n          ? options.discoveryIntervalMs\n          : 1500,\n      discoveryTimeoutMs:\n        typeof options.discoveryTimeoutMs === 'number' && options.discoveryTimeoutMs > 0\n          ? options.discoveryTimeoutMs\n          : 20000,\n      onAllow: options.onAllow,\n      onBlock: options.onBlock,\n      onChallenge: options.onChallenge,\n      onHold: options.onHold,\n      onError: options.onError,\n      onDetectionUpdate: options.onDetectionUpdate,\n    };\n\n    this.log('Initialized with config', this.config);\n    console.info(\n      `[FormBlocker ${FORM_BLOCKER_VERSION}] Initialized (selector: \"${this.config.selector}\", evaluateUrl: \"${this.config.evaluateUrl}\", previewMode: ${this.config.previewMode})`\n    );\n    this.attachToForms();\n    this.startMutationObserver();\n    this.startDiscoveryLoop();\n  }\n\n  refresh(): void {\n    if (!this.config) {\n      this.log('Refresh skipped: config not initialized');\n      return;\n    }\n    this.attachToForms();\n  }\n\n  destroy(): void {\n    this.stopMutationObserver();\n    this.stopDiscoveryLoop();\n    this.contexts.forEach((context, form) => {\n      form.removeAttribute('data-fb-attached');\n      form.removeEventListener('submit', context.submitHandler, true);\n      context.pasteHandlers.forEach(({ element, handler }) => {\n        element.removeEventListener('paste', handler);\n      });\n      context.inputHandlers.forEach(({ element, handler }) => {\n        element.removeEventListener('input', handler);\n      });\n    });\n    this.contexts.clear();\n    this.lastFoundFormsCount = -1;\n  }\n\n  private attachToForms(): void {\n    if (!this.config) {\n      return;\n    }\n\n    console.info(\n      `[FormBlocker ${FORM_BLOCKER_VERSION}] Scanning forms (selector: \"${this.config.selector}\")`\n    );\n\n    // Clean up contexts for forms that were removed from the DOM\n    this.contexts.forEach((context, form) => {\n      if (!document.body.contains(form)) {\n        form.removeEventListener('submit', context.submitHandler, true);\n        context.pasteHandlers.forEach(({ element, handler }) => {\n          element.removeEventListener('paste', handler);\n        });\n        context.inputHandlers.forEach(({ element, handler }) => {\n          element.removeEventListener('input', handler);\n        });\n        this.contexts.delete(form);\n      }\n    });\n\n    const forms = document.querySelectorAll<HTMLFormElement>(this.config.selector);\n    this.log('Searching forms with selector', {\n      selector: this.config.selector,\n      found: forms.length,\n    });\n    if (forms.length === 0) {\n      if (this.lastFoundFormsCount !== 0) {\n        console.warn(\n          `[FormBlocker ${FORM_BLOCKER_VERSION}] No forms matched selector ${this.config.selector}`\n        );\n      }\n    } else if (forms.length !== this.lastFoundFormsCount) {\n      console.info(\n        `[FormBlocker ${FORM_BLOCKER_VERSION}] Found ${forms.length} form(s) for selector \"${this.config.selector}\"`\n      );\n    }\n    this.lastFoundFormsCount = forms.length;\n    forms.forEach((form) => {\n      if (this.contexts.has(form)) {\n        return;\n      }\n      this.attachToForm(form);\n    });\n  }\n\n  private startMutationObserver(): void {\n    if (!this.config?.observeMutations) {\n      this.log('Mutation observer disabled via config');\n      return;\n    }\n    if (typeof MutationObserver === 'undefined' || typeof document === 'undefined') {\n      this.log('MutationObserver not available in this environment');\n      return;\n    }\n    if (this.mutationObserver) {\n      this.mutationObserver.disconnect();\n    }\n    this.mutationObserver = new MutationObserver((mutations) => {\n      let shouldScan = false;\n      for (const mutation of mutations) {\n        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {\n          shouldScan = true;\n          break;\n        }\n      }\n      if (shouldScan) {\n        console.info(`[FormBlocker ${FORM_BLOCKER_VERSION}] DOM mutation detected, rescanning forms`);\n        this.scheduleAttachScan();\n      }\n    });\n    this.mutationObserver.observe(document.body, { childList: true, subtree: true });\n    console.info(`[FormBlocker ${FORM_BLOCKER_VERSION}] Watching DOM for newly added forms`);\n  }\n\n  private stopMutationObserver(): void {\n    if (this.mutationObserver) {\n      this.mutationObserver.disconnect();\n      this.mutationObserver = null;\n    }\n    this.pendingAttachScan = false;\n  }\n\n  private startDiscoveryLoop(): void {\n    if (!this.config) return;\n    const interval = this.config.discoveryIntervalMs;\n    if (!(interval > 0)) {\n      this.log('Discovery loop disabled (interval <= 0)');\n      return;\n    }\n    this.stopDiscoveryLoop();\n    const runScan = () => this.attachToForms();\n    this.discoveryInterval = window.setInterval(runScan, interval);\n    const timeout = this.config.discoveryTimeoutMs;\n    if (timeout && timeout > 0) {\n      this.discoveryTimeoutTimer = window.setTimeout(() => {\n        this.stopDiscoveryLoop();\n        this.log('Discovery loop stopped after timeout');\n      }, timeout);\n    }\n    console.info(\n      `[FormBlocker ${FORM_BLOCKER_VERSION}] Discovery loop started (interval: ${interval}ms${\n        timeout && timeout > 0 ? `, timeout: ${timeout}ms` : ''\n      })`\n    );\n  }\n\n  private stopDiscoveryLoop(): void {\n    if (this.discoveryInterval) {\n      window.clearInterval(this.discoveryInterval);\n      this.discoveryInterval = null;\n    }\n    if (this.discoveryTimeoutTimer) {\n      window.clearTimeout(this.discoveryTimeoutTimer);\n      this.discoveryTimeoutTimer = null;\n    }\n  }\n\n  private scheduleAttachScan(): void {\n    if (this.pendingAttachScan) return;\n    this.pendingAttachScan = true;\n    const schedule = typeof window !== 'undefined' && window.requestAnimationFrame\n      ? window.requestAnimationFrame\n      : (cb: FrameRequestCallback) => setTimeout(cb, 16);\n    schedule(() => {\n      this.pendingAttachScan = false;\n      this.attachToForms();\n    });\n  }\n\n  private attachToForm(form: HTMLFormElement): void {\n    if (!this.config) {\n      return;\n    }\n\n    const behavioral: BehavioralSnapshot = {\n      pasteDetected: false,\n      timeToSubmit: null,\n      pageLoadTime: Date.now(),\n    };\n\n    const submitHandler = (event: Event) => {\n      this.handleSubmit(event as SubmitEvent, form, behavioral).catch((error) => {\n        this.log('Submission handling failed', error);\n      });\n    };\n\n    const pasteHandlers: Array<{ element: Element; handler: EventListener }> = [];\n    const inputHandlers: Array<{ element: Element; handler: EventListener }> = [];\n    const inputElements = form.querySelectorAll('input, textarea');\n    inputElements.forEach((element) => {\n      const handler = () => {\n        behavioral.pasteDetected = true;\n        this.log('Paste detected for form', form);\n        this.emitDetectionUpdate(form, behavioral);\n      };\n      element.addEventListener('paste', handler);\n      pasteHandlers.push({ element, handler });\n    });\n\n    inputElements.forEach((element) => {\n      const handler = () => {\n        this.emitDetectionUpdate(form, behavioral);\n      };\n      element.addEventListener('input', handler);\n      inputHandlers.push({ element, handler });\n    });\n\n    form.addEventListener('submit', submitHandler, true);\n    form.setAttribute('data-fb-attached', 'true');\n\n    this.emitDetectionUpdate(form, behavioral);\n\n    this.contexts.set(form, {\n      originalSubmit: form.onsubmit,\n      submitHandler,\n      pasteHandlers,\n      inputHandlers,\n      behavioral,\n    });\n\n    this.log('Attached to form', form);\n    console.info(\n      `[FormBlocker ${FORM_BLOCKER_VERSION}] Attached to form (selector: \"${this.config.selector}\")`,\n      form\n    );\n  }\n\n  private async handleSubmit(\n    event: SubmitEvent,\n    form: HTMLFormElement,\n    behavioral: BehavioralSnapshot\n  ): Promise<void> {\n    if (!this.config) {\n      return;\n    }\n\n    event.preventDefault();\n    event.stopPropagation();\n    this.log('Intercepted submit', { selector: this.config.selector });\n\n    behavioral.timeToSubmit = (Date.now() - behavioral.pageLoadTime) / 1000;\n\n    this.showLoading(form);\n\n    this.emitDetectionUpdate(form, behavioral);\n\n    try {\n      const payload = this.buildRequestBody(form, behavioral);\n      this.log('Submitting payload', payload);\n\n      const response = await fetch(this.config.evaluateUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        throw new Error(`API request failed with status ${response.status}`);\n      }\n\n      const result = (await response.json()) as EvaluateResponsePayload;\n      this.log('Received response', result);\n\n      if (!result.success) {\n        const message = result.error?.message || 'エラーが発生しました。後ほど再度お試しください。';\n        showBanner(message, 'error');\n        this.config.onError?.(result);\n        this.hideLoading(form);\n        return;\n      }\n\n      this.handleDecision(result, form);\n    } catch (error) {\n      console.error('[FormBlocker] API error', error);\n      this.config.onError?.(error);\n      this.hideLoading(form);\n      this.allowSubmission(form);\n    }\n  }\n\n  private buildRequestBody(form: HTMLFormElement, behavioral: BehavioralSnapshot) {\n    const metadata = {\n      url: typeof window !== 'undefined' ? window.location.href : '',\n      user_agent: typeof navigator !== 'undefined' ? navigator.userAgent : '',\n      timestamp: Date.now(),\n    };\n\n    const behavioralData: Record<string, unknown> = {\n      paste_detected: behavioral.pasteDetected,\n    };\n\n    if (typeof behavioral.timeToSubmit === 'number' && !Number.isNaN(behavioral.timeToSubmit)) {\n      behavioralData.time_to_submit = behavioral.timeToSubmit;\n    }\n\n    return {\n      api_key: this.config?.apiKey,\n      form_data: this.extractFormData(form),\n      metadata,\n      behavioral_data: behavioralData,\n    };\n  }\n\n  private extractFormData(form: HTMLFormElement): Record<string, unknown> {\n    const data: Record<string, unknown> = {};\n    const elements = Array.from(form.elements) as Array<HTMLInputElement | HTMLTextAreaElement>;\n\n    elements.forEach((element) => {\n      if (!element.name) {\n        return;\n      }\n\n      const type = (element as HTMLInputElement).type;\n      if (type === 'checkbox') {\n        const input = element as HTMLInputElement;\n        if (!data[element.name]) {\n          data[element.name] = [];\n        }\n        if (input.checked) {\n          (data[element.name] as unknown[]).push(input.value);\n        }\n        return;\n      }\n\n      if (type === 'radio') {\n        const input = element as HTMLInputElement;\n        if (input.checked) {\n          data[element.name] = input.value;\n        } else if (!(element.name in data)) {\n          data[element.name] = null;\n        }\n        return;\n      }\n\n      data[element.name] = element.value;\n    });\n\n    return data;\n  }\n\n  private handleDecision(result: EvaluateSuccessResponse, form: HTMLFormElement): void {\n    this.log('Handling decision', {\n      decision: result.decision,\n      scores: result.scores,\n      reasons: result.reasons,\n      challenge: result.challenge,\n      submissionId: result.submission_id,\n    });\n    switch (result.decision) {\n      case 'allowed':\n        this.allowSubmission(form);\n        this.hideLoading(form);\n        this.config?.onAllow?.(result);\n        break;\n      case 'challenged':\n        this.hideLoading(form);\n        this.handleChallenge(result, form);\n        break;\n      case 'held':\n        this.hideLoading(form);\n        showBanner(result.message, 'info');\n        this.config?.onHold?.(result);\n        break;\n      case 'blocked':\n        this.hideLoading(form);\n        showBlockModal(result);\n        this.config?.onBlock?.(result);\n        break;\n      default:\n        this.hideLoading(form);\n        this.allowSubmission(form);\n    }\n  }\n\n  private handleChallenge(result: EvaluateSuccessResponse, form: HTMLFormElement): void {\n    this.log('Challenge presented', {\n      question: result.challenge?.question,\n      submissionId: result.submission_id,\n    });\n    const allow = () => {\n      this.allowSubmission(form);\n      this.config?.onAllow?.(result);\n    };\n\n    if (this.config?.onChallenge) {\n      this.config.onChallenge(result, allow);\n      return;\n    }\n\n    const question =\n      result.challenge?.question || 'この送信は営業目的ではありませんか？送信を続けますか？';\n    const confirmed = window.confirm(`${question}\\n\\n「OK」を押すと送信されます。`);\n    if (confirmed) {\n      allow();\n    }\n  }\n\n  private allowSubmission(form: HTMLFormElement): void {\n    if (this.config?.previewMode) {\n      this.log('Preview mode enabled: submission prevented');\n      return;\n    }\n    this.log('Allowing native submission');\n    const context = this.contexts.get(form);\n    if (context?.originalSubmit) {\n      const event = new Event('submit', { bubbles: true, cancelable: true });\n      context.originalSubmit.call(form, event as SubmitEvent);\n    } else {\n      form.submit();\n    }\n  }\n\n  private showLoading(form: HTMLFormElement): void {\n    if (!form.querySelector('.fb-loading')) {\n      const overlay = createOverlay();\n      const style = window.getComputedStyle(form);\n      if (style.position === 'static' || !style.position) {\n        form.style.position = 'relative';\n      }\n      form.appendChild(overlay);\n    }\n  }\n\n  private hideLoading(form: HTMLFormElement): void {\n    const overlay = form.querySelector('.fb-loading');\n    if (overlay && overlay.parentElement) {\n      overlay.parentElement.removeChild(overlay);\n    }\n  }\n\n  private isDebugEnabled(): boolean {\n    if (this.config?.debug) return true;\n    if (typeof window === 'undefined') return false;\n\n    const flagFromWindow = (window as { FormBlockerDebug?: boolean }).FormBlockerDebug === true;\n    const flagFromStorage = localStorage.getItem('formblocker:debug') === 'true';\n    const params = new URLSearchParams(window.location.search);\n    const flagFromQuery = params.get('fb_debug') === '1' || params.get('formblocker_debug') === '1';\n\n    return flagFromWindow || flagFromStorage || flagFromQuery;\n  }\n\n  private log(message: string, payload?: unknown): void {\n    if (!this.isDebugEnabled()) return;\n    if (payload !== undefined) {\n      console.log(`[FormBlocker ${FORM_BLOCKER_VERSION}] ${message}`, payload);\n    } else {\n      console.log(`[FormBlocker ${FORM_BLOCKER_VERSION}] ${message}`);\n    }\n  }\n\n  private emitDetectionUpdate(form: HTMLFormElement, behavioral: BehavioralSnapshot): void {\n    const context = this.contexts.get(form);\n    const formData = this.extractFormData(form);\n    const snapshot = this.analyzeDetection(formData, behavioral);\n\n    context && (context.lastDetection = snapshot);\n\n    this.log('Detection snapshot', snapshot);\n\n    this.config?.onDetectionUpdate?.(snapshot);\n  }\n\n  private analyzeDetection(formData: Record<string, unknown>, behavioral: BehavioralSnapshot): DetectionSnapshot {\n    const textFragments = Object.values(formData).map((value) => {\n      if (typeof value === 'string') return value;\n      if (Array.isArray(value)) return value.join(' ');\n      return '';\n    });\n\n    const values = textFragments.join(' ').toLowerCase();\n\n    const urlRegex = /(https?:\\/\\/[^\\s]+)/gi;\n    const detectedUrls = values.match(urlRegex) || [];\n    const schedulingUrls = detectedUrls.filter((url) => {\n      const domain = extractHostname(url);\n      if (!domain) return false;\n      return DEFAULT_SCHEDULING_DOMAINS.some((target) => matchesDomain(domain, target));\n    });\n\n    const salesKeywords = this.config?.salesKeywords || DEFAULT_SALES_KEYWORDS;\n    const bannedKeywords = this.config?.bannedKeywords || DEFAULT_BANNED_KEYWORDS;\n\n    const detectedSales = salesKeywords.filter((kw) => kw && values.includes(kw.toLowerCase()));\n    const detectedBanned = bannedKeywords.filter((kw) => kw && values.includes(kw.toLowerCase()));\n\n    const emailDomains = collectEmailDomains(formData);\n    const blockedDomainMatches: string[] = [];\n    const configuredBlockedDomains = this.config?.blockedDomains || [];\n\n    if (configuredBlockedDomains.length > 0) {\n      const urlDomains = Array.from(\n        new Set(\n          detectedUrls\n            .map((url) => extractHostname(url))\n            .filter((domain): domain is string => Boolean(domain))\n        )\n      );\n      const candidates = Array.from(new Set([...urlDomains, ...emailDomains])).map(normalizeDomain);\n      candidates.forEach((domain) => {\n        if (configuredBlockedDomains.some((blocked) => matchesDomain(domain, blocked))) {\n          blockedDomainMatches.push(domain);\n        }\n      });\n    }\n\n    return {\n      urlDetected: detectedUrls.length > 0,\n      detectedUrls,\n      schedulingUrls,\n      salesKeywords: detectedSales,\n      bannedKeywords: detectedBanned,\n      blockedDomains: blockedDomainMatches,\n      pasteDetected: behavioral.pasteDetected,\n      contentLength: values.length,\n      updatedAt: Date.now(),\n    };\n  }\n}\n\nconst core = new FormBlockerCore();\n\nconst FormBlocker = {\n  init(options: FormBlockerInitOptions): void {\n    if (typeof window !== 'undefined') {\n      const persistentDebug = localStorage.getItem('formblocker:debug');\n      const globalFlag = (window as { FormBlockerDebug?: boolean }).FormBlockerDebug === true;\n      const params = new URLSearchParams(window.location.search);\n      const queryDebug = params.get('fb_debug') === '1' || params.get('formblocker_debug') === '1';\n\n      if (persistentDebug === 'true' || globalFlag || queryDebug) {\n        options = { ...options, debug: true };\n      }\n    }\n    core.init(options);\n\n    // Always log one line soオペレーション側が初期化に気づける\n    console.info(\n      `[FormBlocker ${FORM_BLOCKER_VERSION}] init called`,\n      {\n        selector: options.selector || 'form',\n        debug: options.debug,\n        previewMode: options.previewMode,\n      }\n    );\n  },\n  refresh(): void {\n    core.refresh();\n  },\n  destroy(): void {\n    core.destroy();\n  },\n};\n\ndeclare global {\n  interface Window {\n    FormBlocker?: typeof FormBlocker;\n    FormBlockerAutoInit?: FormBlockerInitOptions;\n  }\n}\n\nif (typeof window !== 'undefined') {\n  console.info(`[FormBlocker ${FORM_BLOCKER_VERSION}] Script loaded`);\n  window.FormBlocker = FormBlocker;\n  (window as typeof window & { FormBlockerVersion?: string }).FormBlockerVersion = FORM_BLOCKER_VERSION;\n\n  const autoInit = window.FormBlockerAutoInit;\n  if (autoInit) {\n    FormBlocker.init(autoInit);\n  }\n\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n      const pendingConfig = window.FormBlockerAutoInit;\n      if (pendingConfig) {\n        FormBlocker.init(pendingConfig);\n      }\n    });\n  }\n}\n\nexport default FormBlocker;\n"],"names":["FORM_BLOCKER_VERSION","DEFAULT_API_BASE","DEFAULT_SALES_KEYWORDS","DEFAULT_BANNED_KEYWORDS","DEFAULT_SCHEDULING_DOMAINS","normalizeDomain","domain","matchesDomain","target","extractHostname","url","_a","match","collectEmailDomains","formData","domains","regex","value","matches","resolveEvaluateUrl","options","optionBase","trimmedBase","evaluatePath","createOverlay","overlay","spinner","style","modalStylesInjected","ensureModalStyles","getHeroSymbol","type","showDecisionModal","modal","hero","closeModal","closeButton","title","subtitle","element","message","list","reason","item","note","submission","actions","primaryButton","dismissButton","event","showBlockModal","result","showBanner","div","FormBlockerCore","_b","_c","_d","_e","_f","normalizeKeywords","keywords","kw","context","form","handler","forms","mutations","shouldScan","mutation","interval","runScan","timeout","cb","behavioral","submitHandler","error","pasteHandlers","inputHandlers","inputElements","payload","response","metadata","behavioralData","data","input","allow","question","flagFromWindow","flagFromStorage","params","flagFromQuery","snapshot","values","urlRegex","detectedUrls","schedulingUrls","salesKeywords","bannedKeywords","detectedSales","detectedBanned","emailDomains","blockedDomainMatches","configuredBlockedDomains","urlDomains","blocked","core","FormBlocker","persistentDebug","globalFlag","queryDebug","autoInit","pendingConfig"],"mappings":"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"}