{"version":3,"file":"form-blocker.min.js","sources":["../../embed-script/src/index.ts"],"sourcesContent":["type SubmissionDecision = 'allowed' | 'challenged' | 'held' | 'blocked';\n\ninterface ChallengePayload {\n  type?: string;\n  question?: string;\n}\n\ninterface EvaluateSuccessResponse {\n  success: true;\n  decision: SubmissionDecision;\n  message: string;\n  submission_id?: string;\n  scores?: {\n    sales: number;\n    spam: number;\n  };\n  reasons?: string[];\n  challenge?: ChallengePayload;\n}\n\ninterface EvaluateErrorResponse {\n  success: false;\n  error: {\n    code?: string;\n    message?: string;\n  };\n}\n\ntype EvaluateResponsePayload = EvaluateSuccessResponse | EvaluateErrorResponse;\n\ninterface DetectionSnapshot {\n  urlDetected: boolean;\n  detectedUrls: string[];\n  schedulingUrls: string[];\n  salesKeywords: string[];\n  bannedKeywords: string[];\n  blockedDomains: string[];\n  pasteDetected: boolean;\n  contentLength: number;\n  updatedAt: number;\n}\n\nexport interface FormBlockerInitOptions {\n  apiKey: string;\n  apiBaseUrl?: string;\n  evaluatePath?: string;\n  selector?: string;\n  debug?: boolean;\n  previewMode?: boolean;\n  debugRules?: {\n    salesKeywords?: string[];\n    bannedKeywords?: string[];\n    blockedDomains?: string[];\n  };\n  onAllow?: (result: EvaluateSuccessResponse) => void;\n  onBlock?: (result: EvaluateSuccessResponse) => void;\n  onChallenge?: (result: EvaluateSuccessResponse, allow: () => void) => void;\n  onHold?: (result: EvaluateSuccessResponse) => void;\n  onError?: (error: unknown) => void;\n  onDetectionUpdate?: (snapshot: DetectionSnapshot) => void;\n}\n\ninterface InternalConfig {\n  apiKey: string;\n  evaluateUrl: string;\n  selector: string;\n  debug: boolean;\n  previewMode: boolean;\n  salesKeywords: string[];\n  bannedKeywords: string[];\n  blockedDomains: string[];\n  onAllow?: FormBlockerInitOptions['onAllow'];\n  onBlock?: FormBlockerInitOptions['onBlock'];\n  onChallenge?: FormBlockerInitOptions['onChallenge'];\n  onHold?: FormBlockerInitOptions['onHold'];\n  onError?: FormBlockerInitOptions['onError'];\n  onDetectionUpdate?: FormBlockerInitOptions['onDetectionUpdate'];\n}\n\ninterface BehavioralSnapshot {\n  pasteDetected: boolean;\n  timeToSubmit: number | null;\n  pageLoadTime: number;\n}\n\ninterface FormContext {\n  originalSubmit: ((this: HTMLFormElement, ev: SubmitEvent) => unknown) | null;\n  submitHandler: EventListener;\n  pasteHandlers: Array<{ element: Element; handler: EventListener }>;\n  inputHandlers: Array<{ element: Element; handler: EventListener }>;\n  behavioral: BehavioralSnapshot;\n  lastDetection?: DetectionSnapshot;\n}\n\nconst FORM_BLOCKER_VERSION = '2024-11-07-block-modal';\n\nconst DEFAULT_SALES_KEYWORDS = ['営業', 'セールス', '提案', '御社', '貴社', '販売', '広告', '代理店'];\nconst DEFAULT_BANNED_KEYWORDS = ['無料', '限定', '販売促進', '広告代理店'];\nconst DEFAULT_SCHEDULING_DOMAINS = [\n  'calendly.com',\n  'youcanbook.me',\n  'scheduleonce.com',\n  'acuityscheduling.com',\n  'savvycal.com',\n  'hubspot.com',\n  'meetings.hubspot.com',\n  'tidycal.com',\n  'cal.com',\n];\n\nfunction normalizeDomain(domain: string): string {\n  return domain.trim().toLowerCase();\n}\n\nfunction matchesDomain(domain: string, target: string): boolean {\n  return domain === target || domain.endsWith(`.${target}`);\n}\n\nfunction extractHostname(url: string): string | null {\n  try {\n    return new URL(url).hostname.toLowerCase();\n  } catch {\n    const match = url.match(/https?:\\/\\/([^/\\s]+)/i);\n    return match?.[1]?.toLowerCase() ?? null;\n  }\n}\n\nfunction collectEmailDomains(formData: Record<string, unknown>): string[] {\n  const domains = new Set<string>();\n  const regex = /[\\w.+-]+@([A-Za-z0-9.-]+\\.[A-Za-z]{2,})/g;\n  Object.values(formData).forEach((value) => {\n    if (typeof value !== 'string') {\n      return;\n    }\n    const matches = value.matchAll(regex);\n    for (const match of matches) {\n      if (match[1]) {\n        domains.add(match[1].toLowerCase());\n      }\n    }\n  });\n  return Array.from(domains);\n}\n\nfunction resolveEvaluateUrl(options: FormBlockerInitOptions): string {\n  const baseUrl =\n    (options.apiBaseUrl && options.apiBaseUrl.trim()) ||\n    (typeof window !== 'undefined' ? window.location.origin : '');\n  const trimmedBase = baseUrl.replace(/\\/+$/, '');\n  const evaluatePath = (options.evaluatePath || '/api/v1/evaluate').trim() || '/api/v1/evaluate';\n  if (/^https?:\\/\\//i.test(evaluatePath)) {\n    return evaluatePath;\n  }\n  return `${trimmedBase}${evaluatePath.startsWith('/') ? evaluatePath : `/${evaluatePath}`}`;\n}\n\nfunction createOverlay(): HTMLDivElement {\n  const overlay = document.createElement('div');\n  overlay.className = 'fb-loading';\n  overlay.style.cssText = [\n    'position:absolute',\n    'top:0',\n    'left:0',\n    'right:0',\n    'bottom:0',\n    'background:rgba(255,255,255,0.8)',\n    'display:flex',\n    'align-items:center',\n    'justify-content:center',\n    'z-index:1000',\n  ].join(';');\n\n  const spinner = document.createElement('div');\n  spinner.style.cssText = [\n    'border:4px solid #f3f4f6',\n    'border-top:4px solid #3b82f6',\n    'border-radius:50%',\n    'width:40px',\n    'height:40px',\n    'animation:fb-spin 1s linear infinite',\n  ].join(';');\n\n  overlay.appendChild(spinner);\n\n  if (!document.getElementById('fb-styles')) {\n    const style = document.createElement('style');\n    style.id = 'fb-styles';\n    style.textContent =\n      '@keyframes fb-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';\n    document.head.appendChild(style);\n  }\n\n  return overlay;\n}\n\ntype ModalTone = 'info' | 'warning' | 'error';\n\ninterface ModalOptions {\n  title: string;\n  message: string;\n  type: ModalTone;\n  subtitle?: string;\n  note?: string;\n  reasons?: string[];\n  submissionId?: string;\n  primaryActionLabel?: string;\n  primaryAction?: () => void;\n}\n\nlet modalStylesInjected = false;\n\nfunction ensureModalStyles(): void {\n  if (modalStylesInjected || typeof document === 'undefined') {\n    return;\n  }\n\n  const style = document.createElement('style');\n  style.id = 'fb-modal-styles';\n  style.textContent = `\n.fb-modal-overlay {\n  position: fixed;\n  inset: 0;\n  background: rgba(15, 23, 42, 0.75);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 24px;\n  z-index: 10000;\n  backdrop-filter: blur(2px);\n  transition: opacity 0.2s ease, transform 0.2s ease;\n}\n.fb-modal-overlay.fb-modal-hide {\n  opacity: 0;\n  transform: translateY(8px);\n}\n.fb-modal-window {\n  width: min(480px, calc(100% - 32px));\n  background: #ffffff;\n  color: #0f172a;\n  border-radius: 16px;\n  padding: 28px 28px 24px;\n  position: relative;\n  box-shadow: 0 35px 65px rgba(15, 23, 42, 0.35);\n  font-family: 'Inter', 'Noto Sans JP', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n}\n.fb-modal-hero {\n  width: 60px;\n  height: 60px;\n  border-radius: 18px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 1.8rem;\n  font-weight: 700;\n  margin-bottom: 18px;\n}\n.fb-modal-hero.fb-error {\n  background: rgba(239, 68, 68, 0.15);\n  color: #b91c1c;\n}\n.fb-modal-hero.fb-warning {\n  background: rgba(245, 158, 11, 0.15);\n  color: #92400e;\n}\n.fb-modal-hero.fb-info {\n  background: rgba(14, 165, 233, 0.15);\n  color: #0369a1;\n}\n.fb-modal-window.fb-error {\n  border-top: 4px solid #ef4444;\n}\n.fb-modal-window.fb-warning {\n  border-top: 4px solid #f59e0b;\n}\n.fb-modal-window.fb-info {\n  border-top: 4px solid #0ea5e9;\n}\n.fb-modal-close {\n  position: absolute;\n  top: 12px;\n  right: 12px;\n  border: none;\n  background: transparent;\n  font-size: 1.4rem;\n  color: #94a3b8;\n  cursor: pointer;\n}\n.fb-modal-title {\n  margin: 0 0 12px;\n  font-size: 1.4rem;\n  font-weight: 700;\n}\n.fb-modal-subtitle {\n  margin: 0 0 12px;\n  font-size: 0.95rem;\n  color: #475569;\n  line-height: 1.5;\n}\n.fb-modal-message {\n  margin: 0;\n  line-height: 1.6;\n  color: #1f2937;\n}\n.fb-modal-note {\n  margin-top: 18px;\n  font-size: 0.9rem;\n  color: #475569;\n  background: rgba(148, 163, 184, 0.15);\n  border-radius: 12px;\n  padding: 12px 14px;\n}\n.fb-reason-list {\n  margin: 16px 0 0;\n  padding-left: 20px;\n  color: #475569;\n}\n.fb-reason-list li {\n  margin-bottom: 4px;\n}\n.fb-submission-id {\n  margin-top: 18px;\n  font-size: 0.9rem;\n  color: #64748b;\n  word-break: break-all;\n}\n.fb-modal-actions {\n  margin-top: 24px;\n  display: flex;\n  justify-content: flex-end;\n  gap: 12px;\n}\n.fb-modal-btn {\n  border: none;\n  border-radius: 999px;\n  padding: 10px 18px;\n  font-size: 0.95rem;\n  font-weight: 600;\n  cursor: pointer;\n}\n.fb-modal-btn.fb-secondary {\n  background: #e2e8f0;\n  color: #0f172a;\n}\n.fb-modal-btn.fb-primary {\n  background: #111827;\n  color: #ffffff;\n}\n@media (prefers-color-scheme: dark) {\n  .fb-modal-window {\n    background: #0f172a;\n    color: #e2e8f0;\n    box-shadow: 0 35px 65px rgba(0, 0, 0, 0.65);\n  }\n  .fb-modal-message {\n    color: #e2e8f0;\n  }\n  .fb-reason-list {\n    color: #cbd5f5;\n  }\n  .fb-submission-id {\n    color: #94a3b8;\n  }\n  .fb-modal-btn.fb-secondary {\n    background: #1e293b;\n    color: #e2e8f0;\n  }\n  .fb-modal-btn.fb-primary {\n    background: #22d3ee;\n    color: #0f172a;\n  }\n  .fb-modal-subtitle,\n  .fb-modal-note {\n    color: #cbd5f5;\n    background: rgba(51, 65, 85, 0.6);\n  }\n}\n`;\n\n  document.head.appendChild(style);\n  modalStylesInjected = true;\n}\n\nfunction getHeroSymbol(type: ModalTone): string {\n  switch (type) {\n    case 'error':\n      return '!';\n    case 'warning':\n      return '?';\n    default:\n      return 'ℹ︎';\n  }\n}\n\nfunction showDecisionModal(options: ModalOptions): void {\n  if (typeof document === 'undefined') {\n    return;\n  }\n\n  ensureModalStyles();\n\n  const overlay = document.createElement('div');\n  overlay.className = 'fb-modal-overlay';\n\n  const modal = document.createElement('div');\n  modal.className = `fb-modal-window fb-${options.type}`;\n  modal.setAttribute('role', 'dialog');\n  modal.setAttribute('aria-modal', 'true');\n  modal.setAttribute('aria-label', options.title);\n\n  const hero = document.createElement('div');\n  hero.className = `fb-modal-hero fb-${options.type}`;\n  hero.setAttribute('aria-hidden', 'true');\n  hero.textContent = getHeroSymbol(options.type);\n\n  const closeModal = () => {\n    overlay.classList.add('fb-modal-hide');\n    window.setTimeout(() => {\n      if (overlay.parentElement) {\n        overlay.parentElement.removeChild(overlay);\n      }\n    }, 180);\n  };\n\n  const closeButton = document.createElement('button');\n  closeButton.className = 'fb-modal-close';\n  closeButton.type = 'button';\n  closeButton.setAttribute('aria-label', '閉じる');\n  closeButton.innerHTML = '&times;';\n  closeButton.addEventListener('click', closeModal);\n\n  const title = document.createElement('h2');\n  title.className = 'fb-modal-title';\n  title.textContent = options.title;\n\n  const subtitle = options.subtitle\n    ? (() => {\n        const element = document.createElement('p');\n        element.className = 'fb-modal-subtitle';\n        element.textContent = options.subtitle;\n        return element;\n      })()\n    : null;\n\n  const message = document.createElement('p');\n  message.className = 'fb-modal-message';\n  message.textContent = options.message;\n\n  modal.appendChild(closeButton);\n  modal.appendChild(hero);\n  modal.appendChild(title);\n  if (subtitle) {\n    modal.appendChild(subtitle);\n  }\n  modal.appendChild(message);\n\n  if (options.reasons && options.reasons.length > 0) {\n    const list = document.createElement('ul');\n    list.className = 'fb-reason-list';\n    options.reasons.forEach((reason) => {\n      const item = document.createElement('li');\n      item.textContent = reason;\n      list.appendChild(item);\n    });\n    modal.appendChild(list);\n  }\n\n  if (options.note) {\n    const note = document.createElement('p');\n    note.className = 'fb-modal-note';\n    note.textContent = options.note;\n    modal.appendChild(note);\n  }\n\n  if (options.submissionId) {\n    const submission = document.createElement('p');\n    submission.className = 'fb-submission-id';\n    submission.textContent = `受付ID: ${options.submissionId}`;\n    modal.appendChild(submission);\n  }\n\n  const actions = document.createElement('div');\n  actions.className = 'fb-modal-actions';\n\n  if (options.primaryAction && options.primaryActionLabel) {\n    const primaryButton = document.createElement('button');\n    primaryButton.className = 'fb-modal-btn fb-primary';\n    primaryButton.type = 'button';\n    primaryButton.textContent = options.primaryActionLabel;\n    primaryButton.addEventListener('click', () => {\n      options.primaryAction?.();\n      closeModal();\n    });\n    actions.appendChild(primaryButton);\n  }\n\n  const dismissButton = document.createElement('button');\n  dismissButton.className = 'fb-modal-btn fb-secondary';\n  dismissButton.type = 'button';\n  dismissButton.textContent = '閉じる';\n  dismissButton.addEventListener('click', closeModal);\n  actions.appendChild(dismissButton);\n\n  modal.appendChild(actions);\n  overlay.appendChild(modal);\n\n  overlay.addEventListener('click', (event) => {\n    if (event.target === overlay) {\n      closeModal();\n    }\n  });\n\n  document.body.appendChild(overlay);\n}\n\nfunction showBlockModal(result: EvaluateSuccessResponse): void {\n  const message =\n    result.message || '営業目的または不正な送信と判定されたため、送信をブロックしました。';\n\n  showDecisionModal({\n    title: '送信がブロックされました',\n    subtitle: '申し訳ありませんが、この送信内容は営業目的またはスパムの可能性が高いため送信できませんでした。',\n    message,\n    type: 'error',\n    reasons: result.reasons,\n    submissionId: result.submission_id,\n    note:\n      '心当たりがない場合は、入力内容を見直すか別の連絡手段でお問い合わせください。再送時は URL や営業キーワードが含まれていないかをご確認ください。',\n  });\n}\n\nfunction showBanner(message: string, type: 'info' | 'error'): void {\n  const div = document.createElement('div');\n  div.className = `fb-message fb-${type}`;\n  div.textContent = message;\n  div.style.cssText = [\n    'position:fixed',\n    'top:20px',\n    'left:50%',\n    'transform:translateX(-50%)',\n    'padding:16px 24px',\n    'border-radius:8px',\n    `background:${type === 'error' ? '#ef4444' : '#3b82f6'}`,\n    'color:white',\n    'box-shadow:0 4px 6px rgba(0,0,0,0.1)',\n    'z-index:10000',\n    'font-family:sans-serif',\n  ].join(';');\n\n  document.body.appendChild(div);\n\n  setTimeout(() => {\n    div.style.transition = 'opacity 0.3s';\n    div.style.opacity = '0';\n    setTimeout(() => {\n      if (div.parentElement) {\n        div.parentElement.removeChild(div);\n      }\n    }, 300);\n  }, 3000);\n}\n\nclass FormBlockerCore {\n  private config: InternalConfig | null = null;\n  private contexts = new Map<HTMLFormElement, FormContext>();\n\n  init(options: FormBlockerInitOptions): void {\n    if (typeof window === 'undefined' || typeof document === 'undefined') {\n      return;\n    }\n\n    if (!options || !options.apiKey) {\n      console.error('[FormBlocker] apiKey is required');\n      return;\n    }\n\n    this.destroy();\n\n    const normalizeKeywords = (keywords: string[]) => keywords.map((kw) => kw.toLowerCase());\n\n    this.config = {\n      apiKey: options.apiKey,\n      evaluateUrl: resolveEvaluateUrl(options),\n      selector: options.selector || 'form',\n      debug: Boolean(options.debug),\n      previewMode: Boolean(options.previewMode),\n      salesKeywords: options.debugRules?.salesKeywords?.length\n        ? normalizeKeywords(options.debugRules.salesKeywords)\n        : normalizeKeywords(DEFAULT_SALES_KEYWORDS),\n      bannedKeywords: options.debugRules?.bannedKeywords?.length\n        ? normalizeKeywords(options.debugRules.bannedKeywords)\n        : normalizeKeywords(DEFAULT_BANNED_KEYWORDS),\n      blockedDomains: options.debugRules?.blockedDomains?.length\n        ? options.debugRules.blockedDomains.map(normalizeDomain)\n        : [],\n      onAllow: options.onAllow,\n      onBlock: options.onBlock,\n      onChallenge: options.onChallenge,\n      onHold: options.onHold,\n      onError: options.onError,\n      onDetectionUpdate: options.onDetectionUpdate,\n    };\n\n    this.log('Initialized with config', this.config);\n    this.attachToForms();\n  }\n\n  refresh(): void {\n    if (!this.config) {\n      this.log('Refresh skipped: config not initialized');\n      return;\n    }\n    this.attachToForms();\n  }\n\n  destroy(): void {\n    this.contexts.forEach((context, form) => {\n      form.removeAttribute('data-fb-attached');\n      form.removeEventListener('submit', context.submitHandler, true);\n      context.pasteHandlers.forEach(({ element, handler }) => {\n        element.removeEventListener('paste', handler);\n      });\n      context.inputHandlers.forEach(({ element, handler }) => {\n        element.removeEventListener('input', handler);\n      });\n    });\n    this.contexts.clear();\n  }\n\n  private attachToForms(): void {\n    if (!this.config) {\n      return;\n    }\n\n    const forms = document.querySelectorAll<HTMLFormElement>(this.config.selector);\n    forms.forEach((form) => {\n      if (this.contexts.has(form)) {\n        return;\n      }\n      this.attachToForm(form);\n    });\n  }\n\n  private attachToForm(form: HTMLFormElement): void {\n    if (!this.config) {\n      return;\n    }\n\n    const behavioral: BehavioralSnapshot = {\n      pasteDetected: false,\n      timeToSubmit: null,\n      pageLoadTime: Date.now(),\n    };\n\n    const submitHandler = (event: Event) => {\n      this.handleSubmit(event as SubmitEvent, form, behavioral).catch((error) => {\n        this.log('Submission handling failed', error);\n      });\n    };\n\n    const pasteHandlers: Array<{ element: Element; handler: EventListener }> = [];\n    const inputHandlers: Array<{ element: Element; handler: EventListener }> = [];\n    const inputElements = form.querySelectorAll('input, textarea');\n    inputElements.forEach((element) => {\n      const handler = () => {\n        behavioral.pasteDetected = true;\n        this.log('Paste detected for form', form);\n        this.emitDetectionUpdate(form, behavioral);\n      };\n      element.addEventListener('paste', handler);\n      pasteHandlers.push({ element, handler });\n    });\n\n    inputElements.forEach((element) => {\n      const handler = () => {\n        this.emitDetectionUpdate(form, behavioral);\n      };\n      element.addEventListener('input', handler);\n      inputHandlers.push({ element, handler });\n    });\n\n    form.addEventListener('submit', submitHandler, true);\n    form.setAttribute('data-fb-attached', 'true');\n\n    this.emitDetectionUpdate(form, behavioral);\n\n    this.contexts.set(form, {\n      originalSubmit: form.onsubmit,\n      submitHandler,\n      pasteHandlers,\n      inputHandlers,\n      behavioral,\n    });\n\n    this.log('Attached to form', form);\n  }\n\n  private async handleSubmit(\n    event: SubmitEvent,\n    form: HTMLFormElement,\n    behavioral: BehavioralSnapshot\n  ): Promise<void> {\n    if (!this.config) {\n      return;\n    }\n\n    event.preventDefault();\n    event.stopPropagation();\n\n    behavioral.timeToSubmit = (Date.now() - behavioral.pageLoadTime) / 1000;\n\n    this.showLoading(form);\n\n    this.emitDetectionUpdate(form, behavioral);\n\n    try {\n      const payload = this.buildRequestBody(form, behavioral);\n      this.log('Submitting payload', payload);\n\n      const response = await fetch(this.config.evaluateUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        throw new Error(`API request failed with status ${response.status}`);\n      }\n\n      const result = (await response.json()) as EvaluateResponsePayload;\n      this.log('Received response', result);\n\n      if (!result.success) {\n        const message = result.error?.message || 'エラーが発生しました。後ほど再度お試しください。';\n        showBanner(message, 'error');\n        this.config.onError?.(result);\n        this.hideLoading(form);\n        return;\n      }\n\n      this.handleDecision(result, form);\n    } catch (error) {\n      console.error('[FormBlocker] API error', error);\n      this.config.onError?.(error);\n      this.hideLoading(form);\n      this.allowSubmission(form);\n    }\n  }\n\n  private buildRequestBody(form: HTMLFormElement, behavioral: BehavioralSnapshot) {\n    const metadata = {\n      url: typeof window !== 'undefined' ? window.location.href : '',\n      user_agent: typeof navigator !== 'undefined' ? navigator.userAgent : '',\n      timestamp: Date.now(),\n    };\n\n    const behavioralData: Record<string, unknown> = {\n      paste_detected: behavioral.pasteDetected,\n    };\n\n    if (typeof behavioral.timeToSubmit === 'number' && !Number.isNaN(behavioral.timeToSubmit)) {\n      behavioralData.time_to_submit = behavioral.timeToSubmit;\n    }\n\n    return {\n      api_key: this.config?.apiKey,\n      form_data: this.extractFormData(form),\n      metadata,\n      behavioral_data: behavioralData,\n    };\n  }\n\n  private extractFormData(form: HTMLFormElement): Record<string, unknown> {\n    const data: Record<string, unknown> = {};\n    const elements = Array.from(form.elements) as Array<HTMLInputElement | HTMLTextAreaElement>;\n\n    elements.forEach((element) => {\n      if (!element.name) {\n        return;\n      }\n\n      const type = (element as HTMLInputElement).type;\n      if (type === 'checkbox') {\n        const input = element as HTMLInputElement;\n        if (!data[element.name]) {\n          data[element.name] = [];\n        }\n        if (input.checked) {\n          (data[element.name] as unknown[]).push(input.value);\n        }\n        return;\n      }\n\n      if (type === 'radio') {\n        const input = element as HTMLInputElement;\n        if (input.checked) {\n          data[element.name] = input.value;\n        } else if (!(element.name in data)) {\n          data[element.name] = null;\n        }\n        return;\n      }\n\n      data[element.name] = element.value;\n    });\n\n    return data;\n  }\n\n  private handleDecision(result: EvaluateSuccessResponse, form: HTMLFormElement): void {\n    switch (result.decision) {\n      case 'allowed':\n        this.allowSubmission(form);\n        this.hideLoading(form);\n        this.config?.onAllow?.(result);\n        break;\n      case 'challenged':\n        this.hideLoading(form);\n        this.handleChallenge(result, form);\n        break;\n      case 'held':\n        this.hideLoading(form);\n        showBanner(result.message, 'info');\n        this.config?.onHold?.(result);\n        break;\n      case 'blocked':\n        this.hideLoading(form);\n        showBlockModal(result);\n        this.config?.onBlock?.(result);\n        break;\n      default:\n        this.hideLoading(form);\n        this.allowSubmission(form);\n    }\n  }\n\n  private handleChallenge(result: EvaluateSuccessResponse, form: HTMLFormElement): void {\n    const allow = () => {\n      this.allowSubmission(form);\n      this.config?.onAllow?.(result);\n    };\n\n    if (this.config?.onChallenge) {\n      this.config.onChallenge(result, allow);\n      return;\n    }\n\n    const question =\n      result.challenge?.question || 'この送信は営業目的ではありませんか？送信を続けますか？';\n    const confirmed = window.confirm(`${question}\\n\\n「OK」を押すと送信されます。`);\n    if (confirmed) {\n      allow();\n    }\n  }\n\n  private allowSubmission(form: HTMLFormElement): void {\n    if (this.config?.previewMode) {\n      return;\n    }\n    const context = this.contexts.get(form);\n    if (context?.originalSubmit) {\n      const event = new Event('submit', { bubbles: true, cancelable: true });\n      context.originalSubmit.call(form, event as SubmitEvent);\n    } else {\n      form.submit();\n    }\n  }\n\n  private showLoading(form: HTMLFormElement): void {\n    if (!form.querySelector('.fb-loading')) {\n      const overlay = createOverlay();\n      const style = window.getComputedStyle(form);\n      if (style.position === 'static' || !style.position) {\n        form.style.position = 'relative';\n      }\n      form.appendChild(overlay);\n    }\n  }\n\n  private hideLoading(form: HTMLFormElement): void {\n    const overlay = form.querySelector('.fb-loading');\n    if (overlay && overlay.parentElement) {\n      overlay.parentElement.removeChild(overlay);\n    }\n  }\n\n  private log(message: string, payload?: unknown): void {\n    if (!this.config?.debug) return;\n    if (payload !== undefined) {\n      console.log(`[FormBlocker ${FORM_BLOCKER_VERSION}] ${message}`, payload);\n    } else {\n      console.log(`[FormBlocker ${FORM_BLOCKER_VERSION}] ${message}`);\n    }\n  }\n\n  private emitDetectionUpdate(form: HTMLFormElement, behavioral: BehavioralSnapshot): void {\n    if (!this.config?.onDetectionUpdate) {\n      return;\n    }\n\n    const context = this.contexts.get(form);\n    const formData = this.extractFormData(form);\n    const snapshot = this.analyzeDetection(formData, behavioral);\n\n    context && (context.lastDetection = snapshot);\n\n    this.config.onDetectionUpdate(snapshot);\n  }\n\n  private analyzeDetection(formData: Record<string, unknown>, behavioral: BehavioralSnapshot): DetectionSnapshot {\n    const textFragments = Object.values(formData).map((value) => {\n      if (typeof value === 'string') return value;\n      if (Array.isArray(value)) return value.join(' ');\n      return '';\n    });\n\n    const values = textFragments.join(' ').toLowerCase();\n\n    const urlRegex = /(https?:\\/\\/[^\\s]+)/gi;\n    const detectedUrls = values.match(urlRegex) || [];\n    const schedulingUrls = detectedUrls.filter((url) => {\n      const domain = extractHostname(url);\n      if (!domain) return false;\n      return DEFAULT_SCHEDULING_DOMAINS.some((target) => matchesDomain(domain, target));\n    });\n\n    const salesKeywords = this.config?.salesKeywords || DEFAULT_SALES_KEYWORDS;\n    const bannedKeywords = this.config?.bannedKeywords || DEFAULT_BANNED_KEYWORDS;\n\n    const detectedSales = salesKeywords.filter((kw) => kw && values.includes(kw.toLowerCase()));\n    const detectedBanned = bannedKeywords.filter((kw) => kw && values.includes(kw.toLowerCase()));\n\n    const emailDomains = collectEmailDomains(formData);\n    const blockedDomainMatches: string[] = [];\n    const configuredBlockedDomains = this.config?.blockedDomains || [];\n\n    if (configuredBlockedDomains.length > 0) {\n      const urlDomains = Array.from(\n        new Set(\n          detectedUrls\n            .map((url) => extractHostname(url))\n            .filter((domain): domain is string => Boolean(domain))\n        )\n      );\n      const candidates = Array.from(new Set([...urlDomains, ...emailDomains])).map(normalizeDomain);\n      candidates.forEach((domain) => {\n        if (configuredBlockedDomains.some((blocked) => matchesDomain(domain, blocked))) {\n          blockedDomainMatches.push(domain);\n        }\n      });\n    }\n\n    return {\n      urlDetected: detectedUrls.length > 0,\n      detectedUrls,\n      schedulingUrls,\n      salesKeywords: detectedSales,\n      bannedKeywords: detectedBanned,\n      blockedDomains: blockedDomainMatches,\n      pasteDetected: behavioral.pasteDetected,\n      contentLength: values.length,\n      updatedAt: Date.now(),\n    };\n  }\n}\n\nconst core = new FormBlockerCore();\n\nconst FormBlocker = {\n  init(options: FormBlockerInitOptions): void {\n    core.init(options);\n  },\n  refresh(): void {\n    core.refresh();\n  },\n  destroy(): void {\n    core.destroy();\n  },\n};\n\ndeclare global {\n  interface Window {\n    FormBlocker?: typeof FormBlocker;\n    FormBlockerAutoInit?: FormBlockerInitOptions;\n  }\n}\n\nif (typeof window !== 'undefined') {\n  window.FormBlocker = FormBlocker;\n  (window as typeof window & { FormBlockerVersion?: string }).FormBlockerVersion = FORM_BLOCKER_VERSION;\n\n  const autoInit = window.FormBlockerAutoInit;\n  if (autoInit) {\n    FormBlocker.init(autoInit);\n  }\n\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n      const pendingConfig = window.FormBlockerAutoInit;\n      if (pendingConfig) {\n        FormBlocker.init(pendingConfig);\n      }\n    });\n  }\n}\n\nexport default FormBlocker;\n"],"names":["FORM_BLOCKER_VERSION","DEFAULT_SALES_KEYWORDS","DEFAULT_BANNED_KEYWORDS","DEFAULT_SCHEDULING_DOMAINS","normalizeDomain","domain","matchesDomain","target","extractHostname","url","match","_a","collectEmailDomains","formData","domains","regex","value","matches","resolveEvaluateUrl","options","trimmedBase","evaluatePath","createOverlay","overlay","spinner","style","modalStylesInjected","ensureModalStyles","getHeroSymbol","type","showDecisionModal","modal","hero","closeModal","closeButton","title","subtitle","element","message","list","reason","item","note","submission","actions","primaryButton","dismissButton","event","showBlockModal","result","showBanner","div","FormBlockerCore","normalizeKeywords","keywords","kw","_b","_d","_c","_f","_e","context","form","handler","behavioral","submitHandler","error","pasteHandlers","inputHandlers","inputElements","payload","response","metadata","behavioralData","data","input","allow","question","snapshot","values","urlRegex","detectedUrls","schedulingUrls","salesKeywords","bannedKeywords","detectedSales","detectedBanned","emailDomains","blockedDomainMatches","configuredBlockedDomains","urlDomains","blocked","core","FormBlocker","autoInit","pendingConfig"],"mappings":"wCA8FA,MAAMA,EAAuB,yBAEvBC,EAAyB,CAAC,KAAM,OAAQ,KAAM,KAAM,KAAM,KAAM,KAAM,KAAK,EAC3EC,EAA0B,CAAC,KAAM,KAAM,OAAQ,OAAO,EACtDC,EAA6B,CACjC,eACA,gBACA,mBACA,uBACA,eACA,cACA,uBACA,cACA,SACF,EAEA,SAASC,EAAgBC,EAAwB,CAC/C,OAAOA,EAAO,KAAA,EAAO,YAAA,CACvB,CAEA,SAASC,EAAcD,EAAgBE,EAAyB,CAC9D,OAAOF,IAAWE,GAAUF,EAAO,SAAS,IAAIE,CAAM,EAAE,CAC1D,CAEA,SAASC,EAAgBC,EAA4B,OACnD,GAAI,CACF,OAAO,IAAI,IAAIA,CAAG,EAAE,SAAS,YAAA,CAC/B,MAAQ,CACN,MAAMC,EAAQD,EAAI,MAAM,uBAAuB,EAC/C,QAAOE,EAAAD,GAAA,YAAAA,EAAQ,KAAR,YAAAC,EAAY,gBAAiB,IACtC,CACF,CAEA,SAASC,EAAoBC,EAA6C,CACxE,MAAMC,MAAc,IACdC,EAAQ,2CACd,cAAO,OAAOF,CAAQ,EAAE,QAASG,GAAU,CACzC,GAAI,OAAOA,GAAU,SACnB,OAEF,MAAMC,EAAUD,EAAM,SAASD,CAAK,EACpC,UAAWL,KAASO,EACdP,EAAM,CAAC,GACTI,EAAQ,IAAIJ,EAAM,CAAC,EAAE,aAAa,CAGxC,CAAC,EACM,MAAM,KAAKI,CAAO,CAC3B,CAEA,SAASI,EAAmBC,EAAyC,CAInE,MAAMC,GAFHD,EAAQ,YAAcA,EAAQ,WAAW,KAAA,IACzC,OAAO,OAAW,IAAc,OAAO,SAAS,OAAS,KAChC,QAAQ,OAAQ,EAAE,EACxCE,GAAgBF,EAAQ,cAAgB,oBAAoB,QAAU,mBAC5E,MAAI,gBAAgB,KAAKE,CAAY,EAC5BA,EAEF,GAAGD,CAAW,GAAGC,EAAa,WAAW,GAAG,EAAIA,EAAe,IAAIA,CAAY,EAAE,EAC1F,CAEA,SAASC,GAAgC,CACvC,MAAMC,EAAU,SAAS,cAAc,KAAK,EAC5CA,EAAQ,UAAY,aACpBA,EAAQ,MAAM,QAAU,CACtB,oBACA,QACA,SACA,UACA,WACA,mCACA,eACA,qBACA,yBACA,cAAA,EACA,KAAK,GAAG,EAEV,MAAMC,EAAU,SAAS,cAAc,KAAK,EAY5C,GAXAA,EAAQ,MAAM,QAAU,CACtB,2BACA,+BACA,oBACA,aACA,cACA,sCAAA,EACA,KAAK,GAAG,EAEVD,EAAQ,YAAYC,CAAO,EAEvB,CAAC,SAAS,eAAe,WAAW,EAAG,CACzC,MAAMC,EAAQ,SAAS,cAAc,OAAO,EAC5CA,EAAM,GAAK,YACXA,EAAM,YACJ,6FACF,SAAS,KAAK,YAAYA,CAAK,CACjC,CAEA,OAAOF,CACT,CAgBA,IAAIG,EAAsB,GAE1B,SAASC,GAA0B,CACjC,GAAID,GAAuB,OAAO,SAAa,IAC7C,OAGF,MAAMD,EAAQ,SAAS,cAAc,OAAO,EAC5CA,EAAM,GAAK,kBACXA,EAAM,YAAc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAgKpB,SAAS,KAAK,YAAYA,CAAK,EAC/BC,EAAsB,EACxB,CAEA,SAASE,EAAcC,EAAyB,CAC9C,OAAQA,EAAA,CACN,IAAK,QACH,MAAO,IACT,IAAK,UACH,MAAO,IACT,QACE,MAAO,IAAA,CAEb,CAEA,SAASC,EAAkBX,EAA6B,CACtD,GAAI,OAAO,SAAa,IACtB,OAGFQ,EAAA,EAEA,MAAMJ,EAAU,SAAS,cAAc,KAAK,EAC5CA,EAAQ,UAAY,mBAEpB,MAAMQ,EAAQ,SAAS,cAAc,KAAK,EAC1CA,EAAM,UAAY,sBAAsBZ,EAAQ,IAAI,GACpDY,EAAM,aAAa,OAAQ,QAAQ,EACnCA,EAAM,aAAa,aAAc,MAAM,EACvCA,EAAM,aAAa,aAAcZ,EAAQ,KAAK,EAE9C,MAAMa,EAAO,SAAS,cAAc,KAAK,EACzCA,EAAK,UAAY,oBAAoBb,EAAQ,IAAI,GACjDa,EAAK,aAAa,cAAe,MAAM,EACvCA,EAAK,YAAcJ,EAAcT,EAAQ,IAAI,EAE7C,MAAMc,EAAa,IAAM,CACvBV,EAAQ,UAAU,IAAI,eAAe,EACrC,OAAO,WAAW,IAAM,CAClBA,EAAQ,eACVA,EAAQ,cAAc,YAAYA,CAAO,CAE7C,EAAG,GAAG,CACR,EAEMW,EAAc,SAAS,cAAc,QAAQ,EACnDA,EAAY,UAAY,iBACxBA,EAAY,KAAO,SACnBA,EAAY,aAAa,aAAc,KAAK,EAC5CA,EAAY,UAAY,UACxBA,EAAY,iBAAiB,QAASD,CAAU,EAEhD,MAAME,EAAQ,SAAS,cAAc,IAAI,EACzCA,EAAM,UAAY,iBAClBA,EAAM,YAAchB,EAAQ,MAE5B,MAAMiB,EAAWjB,EAAQ,UACpB,IAAM,CACL,MAAMkB,EAAU,SAAS,cAAc,GAAG,EAC1C,OAAAA,EAAQ,UAAY,oBACpBA,EAAQ,YAAclB,EAAQ,SACvBkB,CACT,KACA,KAEEC,EAAU,SAAS,cAAc,GAAG,EAY1C,GAXAA,EAAQ,UAAY,mBACpBA,EAAQ,YAAcnB,EAAQ,QAE9BY,EAAM,YAAYG,CAAW,EAC7BH,EAAM,YAAYC,CAAI,EACtBD,EAAM,YAAYI,CAAK,EACnBC,GACFL,EAAM,YAAYK,CAAQ,EAE5BL,EAAM,YAAYO,CAAO,EAErBnB,EAAQ,SAAWA,EAAQ,QAAQ,OAAS,EAAG,CACjD,MAAMoB,EAAO,SAAS,cAAc,IAAI,EACxCA,EAAK,UAAY,iBACjBpB,EAAQ,QAAQ,QAASqB,GAAW,CAClC,MAAMC,EAAO,SAAS,cAAc,IAAI,EACxCA,EAAK,YAAcD,EACnBD,EAAK,YAAYE,CAAI,CACvB,CAAC,EACDV,EAAM,YAAYQ,CAAI,CACxB,CAEA,GAAIpB,EAAQ,KAAM,CAChB,MAAMuB,EAAO,SAAS,cAAc,GAAG,EACvCA,EAAK,UAAY,gBACjBA,EAAK,YAAcvB,EAAQ,KAC3BY,EAAM,YAAYW,CAAI,CACxB,CAEA,GAAIvB,EAAQ,aAAc,CACxB,MAAMwB,EAAa,SAAS,cAAc,GAAG,EAC7CA,EAAW,UAAY,mBACvBA,EAAW,YAAc,SAASxB,EAAQ,YAAY,GACtDY,EAAM,YAAYY,CAAU,CAC9B,CAEA,MAAMC,EAAU,SAAS,cAAc,KAAK,EAG5C,GAFAA,EAAQ,UAAY,mBAEhBzB,EAAQ,eAAiBA,EAAQ,mBAAoB,CACvD,MAAM0B,EAAgB,SAAS,cAAc,QAAQ,EACrDA,EAAc,UAAY,0BAC1BA,EAAc,KAAO,SACrBA,EAAc,YAAc1B,EAAQ,mBACpC0B,EAAc,iBAAiB,QAAS,IAAM,QAC5ClC,EAAAQ,EAAQ,gBAAR,MAAAR,EAAA,KAAAQ,GACAc,EAAA,CACF,CAAC,EACDW,EAAQ,YAAYC,CAAa,CACnC,CAEA,MAAMC,EAAgB,SAAS,cAAc,QAAQ,EACrDA,EAAc,UAAY,4BAC1BA,EAAc,KAAO,SACrBA,EAAc,YAAc,MAC5BA,EAAc,iBAAiB,QAASb,CAAU,EAClDW,EAAQ,YAAYE,CAAa,EAEjCf,EAAM,YAAYa,CAAO,EACzBrB,EAAQ,YAAYQ,CAAK,EAEzBR,EAAQ,iBAAiB,QAAUwB,GAAU,CACvCA,EAAM,SAAWxB,GACnBU,EAAA,CAEJ,CAAC,EAED,SAAS,KAAK,YAAYV,CAAO,CACnC,CAEA,SAASyB,EAAeC,EAAuC,CAC7D,MAAMX,EACJW,EAAO,SAAW,oCAEpBnB,EAAkB,CAChB,MAAO,eACP,SAAU,kDACV,QAAAQ,EACA,KAAM,QACN,QAASW,EAAO,QAChB,aAAcA,EAAO,cACrB,KACE,2EAAA,CACH,CACH,CAEA,SAASC,EAAWZ,EAAiBT,EAA8B,CACjE,MAAMsB,EAAM,SAAS,cAAc,KAAK,EACxCA,EAAI,UAAY,iBAAiBtB,CAAI,GACrCsB,EAAI,YAAcb,EAClBa,EAAI,MAAM,QAAU,CAClB,iBACA,WACA,WACA,6BACA,oBACA,oBACA,cAActB,IAAS,QAAU,UAAY,SAAS,GACtD,cACA,uCACA,gBACA,wBAAA,EACA,KAAK,GAAG,EAEV,SAAS,KAAK,YAAYsB,CAAG,EAE7B,WAAW,IAAM,CACfA,EAAI,MAAM,WAAa,eACvBA,EAAI,MAAM,QAAU,IACpB,WAAW,IAAM,CACXA,EAAI,eACNA,EAAI,cAAc,YAAYA,CAAG,CAErC,EAAG,GAAG,CACR,EAAG,GAAI,CACT,CAEA,MAAMC,CAAgB,CAAtB,aAAA,CACE,KAAQ,OAAgC,KACxC,KAAQ,aAAe,GAAkC,CAEzD,KAAKjC,EAAuC,iBAC1C,GAAI,OAAO,OAAW,KAAe,OAAO,SAAa,IACvD,OAGF,GAAI,CAACA,GAAW,CAACA,EAAQ,OAAQ,CAC/B,QAAQ,MAAM,kCAAkC,EAChD,MACF,CAEA,KAAK,QAAA,EAEL,MAAMkC,EAAqBC,GAAuBA,EAAS,IAAKC,GAAOA,EAAG,aAAa,EAEvF,KAAK,OAAS,CACZ,OAAQpC,EAAQ,OAChB,YAAaD,EAAmBC,CAAO,EACvC,SAAUA,EAAQ,UAAY,OAC9B,MAAO,EAAQA,EAAQ,MACvB,YAAa,EAAQA,EAAQ,YAC7B,eAAeqC,GAAA7C,EAAAQ,EAAQ,aAAR,YAAAR,EAAoB,gBAApB,MAAA6C,EAAmC,OAC9CH,EAAkBlC,EAAQ,WAAW,aAAa,EAClDkC,EAAkBpD,CAAsB,EAC5C,gBAAgBwD,GAAAC,EAAAvC,EAAQ,aAAR,YAAAuC,EAAoB,iBAApB,MAAAD,EAAoC,OAChDJ,EAAkBlC,EAAQ,WAAW,cAAc,EACnDkC,EAAkBnD,CAAuB,EAC7C,gBAAgByD,GAAAC,EAAAzC,EAAQ,aAAR,YAAAyC,EAAoB,iBAApB,MAAAD,EAAoC,OAChDxC,EAAQ,WAAW,eAAe,IAAIf,CAAe,EACrD,CAAA,EACJ,QAASe,EAAQ,QACjB,QAASA,EAAQ,QACjB,YAAaA,EAAQ,YACrB,OAAQA,EAAQ,OAChB,QAASA,EAAQ,QACjB,kBAAmBA,EAAQ,iBAAA,EAG7B,KAAK,IAAI,0BAA2B,KAAK,MAAM,EAC/C,KAAK,cAAA,CACP,CAEA,SAAgB,CACd,GAAI,CAAC,KAAK,OAAQ,CAChB,KAAK,IAAI,yCAAyC,EAClD,MACF,CACA,KAAK,cAAA,CACP,CAEA,SAAgB,CACd,KAAK,SAAS,QAAQ,CAAC0C,EAASC,IAAS,CACvCA,EAAK,gBAAgB,kBAAkB,EACvCA,EAAK,oBAAoB,SAAUD,EAAQ,cAAe,EAAI,EAC9DA,EAAQ,cAAc,QAAQ,CAAC,CAAE,QAAAxB,EAAS,QAAA0B,KAAc,CACtD1B,EAAQ,oBAAoB,QAAS0B,CAAO,CAC9C,CAAC,EACDF,EAAQ,cAAc,QAAQ,CAAC,CAAE,QAAAxB,EAAS,QAAA0B,KAAc,CACtD1B,EAAQ,oBAAoB,QAAS0B,CAAO,CAC9C,CAAC,CACH,CAAC,EACD,KAAK,SAAS,MAAA,CAChB,CAEQ,eAAsB,CAC5B,GAAI,CAAC,KAAK,OACR,OAGY,SAAS,iBAAkC,KAAK,OAAO,QAAQ,EACvE,QAASD,GAAS,CAClB,KAAK,SAAS,IAAIA,CAAI,GAG1B,KAAK,aAAaA,CAAI,CACxB,CAAC,CACH,CAEQ,aAAaA,EAA6B,CAChD,GAAI,CAAC,KAAK,OACR,OAGF,MAAME,EAAiC,CACrC,cAAe,GACf,aAAc,KACd,aAAc,KAAK,IAAA,CAAI,EAGnBC,EAAiBlB,GAAiB,CACtC,KAAK,aAAaA,EAAsBe,EAAME,CAAU,EAAE,MAAOE,GAAU,CACzE,KAAK,IAAI,6BAA8BA,CAAK,CAC9C,CAAC,CACH,EAEMC,EAAqE,CAAA,EACrEC,EAAqE,CAAA,EACrEC,EAAgBP,EAAK,iBAAiB,iBAAiB,EAC7DO,EAAc,QAAShC,GAAY,CACjC,MAAM0B,EAAU,IAAM,CACpBC,EAAW,cAAgB,GAC3B,KAAK,IAAI,0BAA2BF,CAAI,EACxC,KAAK,oBAAoBA,EAAME,CAAU,CAC3C,EACA3B,EAAQ,iBAAiB,QAAS0B,CAAO,EACzCI,EAAc,KAAK,CAAE,QAAA9B,EAAS,QAAA0B,CAAA,CAAS,CACzC,CAAC,EAEDM,EAAc,QAAShC,GAAY,CACjC,MAAM0B,EAAU,IAAM,CACpB,KAAK,oBAAoBD,EAAME,CAAU,CAC3C,EACA3B,EAAQ,iBAAiB,QAAS0B,CAAO,EACzCK,EAAc,KAAK,CAAE,QAAA/B,EAAS,QAAA0B,CAAA,CAAS,CACzC,CAAC,EAEDD,EAAK,iBAAiB,SAAUG,EAAe,EAAI,EACnDH,EAAK,aAAa,mBAAoB,MAAM,EAE5C,KAAK,oBAAoBA,EAAME,CAAU,EAEzC,KAAK,SAAS,IAAIF,EAAM,CACtB,eAAgBA,EAAK,SACrB,cAAAG,EACA,cAAAE,EACA,cAAAC,EACA,WAAAJ,CAAA,CACD,EAED,KAAK,IAAI,mBAAoBF,CAAI,CACnC,CAEA,MAAc,aACZf,EACAe,EACAE,EACe,eACf,GAAK,KAAK,OAIV,CAAAjB,EAAM,eAAA,EACNA,EAAM,gBAAA,EAENiB,EAAW,cAAgB,KAAK,IAAA,EAAQA,EAAW,cAAgB,IAEnE,KAAK,YAAYF,CAAI,EAErB,KAAK,oBAAoBA,EAAME,CAAU,EAEzC,GAAI,CACF,MAAMM,EAAU,KAAK,iBAAiBR,EAAME,CAAU,EACtD,KAAK,IAAI,qBAAsBM,CAAO,EAEtC,MAAMC,EAAW,MAAM,MAAM,KAAK,OAAO,YAAa,CACpD,OAAQ,OACR,QAAS,CACP,eAAgB,kBAAA,EAElB,KAAM,KAAK,UAAUD,CAAO,CAAA,CAC7B,EAED,GAAI,CAACC,EAAS,GACZ,MAAM,IAAI,MAAM,kCAAkCA,EAAS,MAAM,EAAE,EAGrE,MAAMtB,EAAU,MAAMsB,EAAS,KAAA,EAG/B,GAFA,KAAK,IAAI,oBAAqBtB,CAAM,EAEhC,CAACA,EAAO,QAAS,CACnB,MAAMX,IAAU3B,EAAAsC,EAAO,QAAP,YAAAtC,EAAc,UAAW,2BACzCuC,EAAWZ,EAAS,OAAO,GAC3BoB,GAAAF,EAAA,KAAK,QAAO,UAAZ,MAAAE,EAAA,KAAAF,EAAsBP,GACtB,KAAK,YAAYa,CAAI,EACrB,MACF,CAEA,KAAK,eAAeb,EAAQa,CAAI,CAClC,OAASI,EAAO,CACd,QAAQ,MAAM,0BAA2BA,CAAK,GAC9CN,GAAAH,EAAA,KAAK,QAAO,UAAZ,MAAAG,EAAA,KAAAH,EAAsBS,GACtB,KAAK,YAAYJ,CAAI,EACrB,KAAK,gBAAgBA,CAAI,CAC3B,EACF,CAEQ,iBAAiBA,EAAuBE,EAAgC,OAC9E,MAAMQ,EAAW,CACf,IAAK,OAAO,OAAW,IAAc,OAAO,SAAS,KAAO,GAC5D,WAAY,OAAO,UAAc,IAAc,UAAU,UAAY,GACrE,UAAW,KAAK,IAAA,CAAI,EAGhBC,EAA0C,CAC9C,eAAgBT,EAAW,aAAA,EAG7B,OAAI,OAAOA,EAAW,cAAiB,UAAY,CAAC,OAAO,MAAMA,EAAW,YAAY,IACtFS,EAAe,eAAiBT,EAAW,cAGtC,CACL,SAASrD,EAAA,KAAK,SAAL,YAAAA,EAAa,OACtB,UAAW,KAAK,gBAAgBmD,CAAI,EACpC,SAAAU,EACA,gBAAiBC,CAAA,CAErB,CAEQ,gBAAgBX,EAAgD,CACtE,MAAMY,EAAgC,CAAA,EAGtC,OAFiB,MAAM,KAAKZ,EAAK,QAAQ,EAEhC,QAASzB,GAAY,CAC5B,GAAI,CAACA,EAAQ,KACX,OAGF,MAAMR,EAAQQ,EAA6B,KAC3C,GAAIR,IAAS,WAAY,CACvB,MAAM8C,EAAQtC,EACTqC,EAAKrC,EAAQ,IAAI,IACpBqC,EAAKrC,EAAQ,IAAI,EAAI,CAAA,GAEnBsC,EAAM,SACPD,EAAKrC,EAAQ,IAAI,EAAgB,KAAKsC,EAAM,KAAK,EAEpD,MACF,CAEA,GAAI9C,IAAS,QAAS,CACpB,MAAM8C,EAAQtC,EACVsC,EAAM,QACRD,EAAKrC,EAAQ,IAAI,EAAIsC,EAAM,MAChBtC,EAAQ,QAAQqC,IAC3BA,EAAKrC,EAAQ,IAAI,EAAI,MAEvB,MACF,CAEAqC,EAAKrC,EAAQ,IAAI,EAAIA,EAAQ,KAC/B,CAAC,EAEMqC,CACT,CAEQ,eAAezB,EAAiCa,EAA6B,iBACnF,OAAQb,EAAO,SAAA,CACb,IAAK,UACH,KAAK,gBAAgBa,CAAI,EACzB,KAAK,YAAYA,CAAI,GACrBN,GAAA7C,EAAA,KAAK,SAAL,YAAAA,EAAa,UAAb,MAAA6C,EAAA,KAAA7C,EAAuBsC,GACvB,MACF,IAAK,aACH,KAAK,YAAYa,CAAI,EACrB,KAAK,gBAAgBb,EAAQa,CAAI,EACjC,MACF,IAAK,OACH,KAAK,YAAYA,CAAI,EACrBZ,EAAWD,EAAO,QAAS,MAAM,GACjCQ,GAAAC,EAAA,KAAK,SAAL,YAAAA,EAAa,SAAb,MAAAD,EAAA,KAAAC,EAAsBT,GACtB,MACF,IAAK,UACH,KAAK,YAAYa,CAAI,EACrBd,EAAeC,CAAM,GACrBU,GAAAC,EAAA,KAAK,SAAL,YAAAA,EAAa,UAAb,MAAAD,EAAA,KAAAC,EAAuBX,GACvB,MACF,QACE,KAAK,YAAYa,CAAI,EACrB,KAAK,gBAAgBA,CAAI,CAAA,CAE/B,CAEQ,gBAAgBb,EAAiCa,EAA6B,SACpF,MAAMc,EAAQ,IAAM,SAClB,KAAK,gBAAgBd,CAAI,GACzBN,GAAA7C,EAAA,KAAK,SAAL,YAAAA,EAAa,UAAb,MAAA6C,EAAA,KAAA7C,EAAuBsC,EACzB,EAEA,IAAItC,EAAA,KAAK,SAAL,MAAAA,EAAa,YAAa,CAC5B,KAAK,OAAO,YAAYsC,EAAQ2B,CAAK,EACrC,MACF,CAEA,MAAMC,IACJrB,EAAAP,EAAO,YAAP,YAAAO,EAAkB,WAAY,8BACd,OAAO,QAAQ,GAAGqB,CAAQ;AAAA;AAAA,gBAAqB,GAE/DD,EAAA,CAEJ,CAEQ,gBAAgBd,EAA6B,OACnD,IAAInD,EAAA,KAAK,SAAL,MAAAA,EAAa,YACf,OAEF,MAAMkD,EAAU,KAAK,SAAS,IAAIC,CAAI,EACtC,GAAID,GAAA,MAAAA,EAAS,eAAgB,CAC3B,MAAMd,EAAQ,IAAI,MAAM,SAAU,CAAE,QAAS,GAAM,WAAY,GAAM,EACrEc,EAAQ,eAAe,KAAKC,EAAMf,CAAoB,CACxD,MACEe,EAAK,OAAA,CAET,CAEQ,YAAYA,EAA6B,CAC/C,GAAI,CAACA,EAAK,cAAc,aAAa,EAAG,CACtC,MAAMvC,EAAUD,EAAA,EACVG,EAAQ,OAAO,iBAAiBqC,CAAI,GACtCrC,EAAM,WAAa,UAAY,CAACA,EAAM,YACxCqC,EAAK,MAAM,SAAW,YAExBA,EAAK,YAAYvC,CAAO,CAC1B,CACF,CAEQ,YAAYuC,EAA6B,CAC/C,MAAMvC,EAAUuC,EAAK,cAAc,aAAa,EAC5CvC,GAAWA,EAAQ,eACrBA,EAAQ,cAAc,YAAYA,CAAO,CAE7C,CAEQ,IAAIe,EAAiBgC,EAAyB,QAC/C3D,EAAA,KAAK,SAAL,MAAAA,EAAa,QACd2D,IAAY,OACd,QAAQ,IAAI,gBAAgBtE,CAAoB,KAAKsC,CAAO,GAAIgC,CAAO,EAEvE,QAAQ,IAAI,gBAAgBtE,CAAoB,KAAKsC,CAAO,EAAE,EAElE,CAEQ,oBAAoBwB,EAAuBE,EAAsC,OACvF,GAAI,GAACrD,EAAA,KAAK,SAAL,MAAAA,EAAa,mBAChB,OAGF,MAAMkD,EAAU,KAAK,SAAS,IAAIC,CAAI,EAChCjD,EAAW,KAAK,gBAAgBiD,CAAI,EACpCgB,EAAW,KAAK,iBAAiBjE,EAAUmD,CAAU,EAE3DH,IAAYA,EAAQ,cAAgBiB,GAEpC,KAAK,OAAO,kBAAkBA,CAAQ,CACxC,CAEQ,iBAAiBjE,EAAmCmD,EAAmD,WAO7G,MAAMe,EANgB,OAAO,OAAOlE,CAAQ,EAAE,IAAKG,GAC7C,OAAOA,GAAU,SAAiBA,EAClC,MAAM,QAAQA,CAAK,EAAUA,EAAM,KAAK,GAAG,EACxC,EACR,EAE4B,KAAK,GAAG,EAAE,YAAA,EAEjCgE,EAAW,wBACXC,EAAeF,EAAO,MAAMC,CAAQ,GAAK,CAAA,EACzCE,EAAiBD,EAAa,OAAQxE,GAAQ,CAClD,MAAMJ,EAASG,EAAgBC,CAAG,EAClC,OAAKJ,EACEF,EAA2B,KAAMI,GAAWD,EAAcD,EAAQE,CAAM,CAAC,EAD5D,EAEtB,CAAC,EAEK4E,IAAgBxE,EAAA,KAAK,SAAL,YAAAA,EAAa,gBAAiBV,EAC9CmF,IAAiB5B,EAAA,KAAK,SAAL,YAAAA,EAAa,iBAAkBtD,EAEhDmF,EAAgBF,EAAc,OAAQ5B,GAAOA,GAAMwB,EAAO,SAASxB,EAAG,YAAA,CAAa,CAAC,EACpF+B,EAAiBF,EAAe,OAAQ7B,GAAOA,GAAMwB,EAAO,SAASxB,EAAG,YAAA,CAAa,CAAC,EAEtFgC,EAAe3E,EAAoBC,CAAQ,EAC3C2E,EAAiC,CAAA,EACjCC,IAA2B/B,EAAA,KAAK,SAAL,YAAAA,EAAa,iBAAkB,CAAA,EAEhE,GAAI+B,EAAyB,OAAS,EAAG,CACvC,MAAMC,EAAa,MAAM,KACvB,IAAI,IACFT,EACG,IAAKxE,GAAQD,EAAgBC,CAAG,CAAC,EACjC,OAAQJ,GAA6B,EAAQA,CAAO,CAAA,CACzD,EAEiB,MAAM,KAAK,IAAI,IAAI,CAAC,GAAGqF,EAAY,GAAGH,CAAY,CAAC,CAAC,EAAE,IAAInF,CAAe,EACjF,QAASC,GAAW,CACzBoF,EAAyB,KAAME,GAAYrF,EAAcD,EAAQsF,CAAO,CAAC,GAC3EH,EAAqB,KAAKnF,CAAM,CAEpC,CAAC,CACH,CAEA,MAAO,CACL,YAAa4E,EAAa,OAAS,EACnC,aAAAA,EACA,eAAAC,EACA,cAAeG,EACf,eAAgBC,EAChB,eAAgBE,EAChB,cAAexB,EAAW,cAC1B,cAAee,EAAO,OACtB,UAAW,KAAK,IAAA,CAAI,CAExB,CACF,CAEA,MAAMa,EAAO,IAAIxC,EAEXyC,EAAc,CAClB,KAAK1E,EAAuC,CAC1CyE,EAAK,KAAKzE,CAAO,CACnB,EACA,SAAgB,CACdyE,EAAK,QAAA,CACP,EACA,SAAgB,CACdA,EAAK,QAAA,CACP,CACF,EASA,GAAI,OAAO,OAAW,IAAa,CACjC,OAAO,YAAcC,EACpB,OAA2D,mBAAqB7F,EAEjF,MAAM8F,EAAW,OAAO,oBACpBA,GACFD,EAAY,KAAKC,CAAQ,EAGvB,SAAS,aAAe,WAC1B,SAAS,iBAAiB,mBAAoB,IAAM,CAClD,MAAMC,EAAgB,OAAO,oBACzBA,GACFF,EAAY,KAAKE,CAAa,CAElC,CAAC,CAEL"}